var Gt=Object.create;var it=Object.defineProperty;var Pt=Object.getOwnPropertyDescriptor;var vt=Object.getOwnPropertyNames;var Lt=Object.getPrototypeOf,Dt=Object.prototype.hasOwnProperty;var St=(c,t)=>()=>(t||c((t={exports:{}}).exports,t),t.exports);var Tt=(c,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of vt(t))!Dt.call(c,n)&&n!==e&&it(c,n,{get:()=>t[n],enumerable:!(r=Pt(t,n))||r.enumerable});return c};var $t=(c,t,e)=>(e=c!=null?Gt(Lt(c)):{},Tt(t||!c||!c.__esModule?it(e,"default",{value:c,enumerable:!0}):e,c));var ct=St((k,j)=>{var k,K;K=(function(){function c(t){var e,r,n,o,a;t==null&&(t={}),this.K=(e=t.K)!=null?e:5,this.maxIterations=(r=t.maxIterations)!=null?r:100,this.enableConvergenceTest=(n=t.enableConvergenceTest)!=null?n:!0,this.tolerance=(o=t.tolerance)!=null?o:1e-9,this.initialize=(a=t.initialize)!=null?a:c.initializeForgy}return c.prototype.cluster=function(t){var e;if(this.X=t,this.prevCentroids=[],this.clusters=[],this.currentIteration=0,e=[this.X.length,this.X[0].length],this.m=e[0],this.n=e[1],this.m==null||this.n==null||this.m<this.K||this.n<1)throw"You must pass more data";return this.centroids=this.initialize(this.X,this.K,this.m,this.n)},c.prototype.step=function(){return this.currentIteration++<this.maxIterations},c.prototype.autoCluster=function(t){var e;for(this.cluster(t),e=[];this.step()&&(this.findClosestCentroids(),this.moveCentroids(),!this.hasConverged());)e.push(void 0);return e},c.initializeForgy=function(t,e,r,n){var o,a,i;for(i=[],o=a=0;0<=e?a<e:a>e;o=0<=e?++a:--a)i.push(t[Math.floor(Math.random()*r)]);return i},c.initializeInRange=function(t,e,r,n){var o,a,i,s,l,u,h,m,p,g,b,x,d,f;for(a=h=0;0<=n?h<n:h>n;a=0<=n?++h:--h)l=1/0;for(a=m=0;0<=n?m<n:m>n;a=0<=n?++m:--m)s=-1/0;for(p=0,b=t.length;p<b;p++)for(u=t[p],a=g=0,x=u.length;g<x;a=++g)o=u[a],l[a]=Math.min(l[a],o),s[a]=Math.max(s[a],o);for(f=[],i=d=0;0<=e?d<e:d>e;i=0<=e?++d:--d)f.push((function(){var R,C;for(C=[],o=R=0;0<=n?R<n:R>n;o=0<=n?++R:--R)C.push(Math.random()*(s[o]-l[o])+l[o]);return C})());return f},c.prototype.findClosestCentroids=function(){var t,e,r,n,o,a,i,s,l,u,h,m,p,g,b,x,d,f;for(this.enableConvergenceTest&&(this.prevCentroids=(function(){var R,C,B,w;for(B=this.centroids,w=[],R=0,C=B.length;R<C;R++)i=B[R],w.push(i.slice(0));return w}).call(this)),this.clusters=(function(){var R,C,B;for(B=[],r=R=0,C=this.K;0<=C?R<C:R>C;r=0<=C?++R:--R)B.push([]);return B}).call(this),b=this.X,f=[],r=u=0,p=b.length;u<p;r=++u){for(s=b[r],e=0,l=1/0,x=this.centroids,n=h=0,g=x.length;h<g;n=++h){for(t=x[n],a=0,o=m=0,d=s.length;0<=d?m<d:m>d;o=0<=d?++m:--m)a+=(s[o]-t[o])*(s[o]-t[o]);a<l&&(e=n,l=a)}f.push(this.clusters[e].push(r))}return f},c.prototype.moveCentroids=function(){var t,e,r,n,o,a,i,s,l;for(s=this.clusters,l=[],r=a=0,i=s.length;a<i;r=++a)t=s[r],!(t.length<1)&&l.push((function(){var u,h,m,p,g;for(g=[],n=u=0,p=this.n;0<=p?u<p:u>p;n=0<=p?++u:--u){for(o=0,h=0,m=t.length;h<m;h++)e=t[h],o+=this.X[e][n];g.push(this.centroids[r][n]=o/t.length)}return g}).call(this));return l},c.prototype.hasConverged=function(){var t,e,r,n,o,a,i;if(!this.enableConvergenceTest)return!1;for(e=n=0,a=this.n;0<=a?n<a:n>a;e=0<=a?++n:--n)for(r=o=0,i=this.m;0<=i?o<i:o>i;r=0<=i?++o:--o)if(t=Math.abs(this.prevCentroids[e][r]-this.centroids[e][r]),this.tolerance>t)return!0;return!1},c})();(typeof j<"u"&&j!==null?j.exports:void 0)!=null||typeof k<"u"&&k!==null?j.exports=k=K:window.kMeans=K});var ht=$t(ct(),1);import ut from"sharp";var U={Xn:.95047,Yn:1,Zn:1.08883},It=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]];function J(c){return c<=.04045?c/12.92:Math.pow((c+.055)/1.055,2.4)}function Q(c){return c<=.0031308?c*12.92:1.055*Math.pow(c,1/2.4)-.055}function A(c){return{R:J(c.R/255),G:J(c.G/255),B:J(c.B/255)}}function I(c){return{R:Math.round(Q(c.R)*255),G:Math.round(Q(c.G)*255),B:Math.round(Q(c.B)*255)}}function L(c){let[t,e,r]=It;return{X:t[0]*c.R+t[1]*c.G+t[2]*c.B,Y:e[0]*c.R+e[1]*c.G+e[2]*c.B,Z:r[0]*c.R+r[1]*c.G+r[2]*c.B}}function tt(c){let t=.20689655172413793;return c>Math.pow(t,3)?Math.pow(c,1/3):c/(3*t*t)+4/29}function D(c){let t=tt(c.X/U.Xn),e=tt(c.Y/U.Yn),r=tt(c.Z/U.Zn);return{L:116*e-16,a:500*(t-e),b:200*(e-r)}}function lt(c){let t=A(c),e=L(t);return D(e)}var H=class{constructor(t={}){this.options={maxColours:t.maxColours??20,minPercentage:t.minPercentage??.5,resampleSize:t.resampleSize??400,iterations:t.iterations??20}}async extract(t,e){let r=Date.now();try{let n=ut(Buffer.from(t)),o=await n.metadata();if(!o.width||!o.height)throw new Error("Invalid image dimensions");let a=Math.max(o.width,o.height),i=a>this.options.resampleSize?this.options.resampleSize/a:1,s=Math.round(o.width*i),l=Math.round(o.height*i),{data:u,info:h}=await n.resize(s,l,{kernel:ut.kernel.lanczos3,fit:"fill"}).removeAlpha().raw().toBuffer({resolveWithObject:!0}),m=[];for(let d=0;d<u.length;d+=3)m.push({R:u[d],G:u[d+1],B:u[d+2]});let p=this.performKMeans(m,this.options.maxColours),g=m.length,b=p.map((d,f)=>{let R=d.centroid,C={R:Math.round(Math.max(0,Math.min(255,R[0]))),G:Math.round(Math.max(0,Math.min(255,R[1]))),B:Math.round(Math.max(0,Math.min(255,R[2])))},B=d.cluster.length,w=B/g*100;return{rgb:C,pixels:B,percentage:w}}).filter(d=>d.percentage>=this.options.minPercentage).sort((d,f)=>f.percentage-d.percentage),x=Date.now()-r;return console.info(`Final palette: ${b.length} colors, top 5 areas: ${b.slice(0,5).map(d=>d.percentage.toFixed(1)+"%").join(", ")}`),console.info(`Extraction completed in ${x}ms`),{colours:b,metadata:{width:o.width,height:o.height,totalPixels:o.width*o.height,format:e}}}catch(n){throw new Error(`Raster extraction failed: ${n.message}`)}}async extractFromCanvas(t){try{let e=t.getContext("2d");if(!e)throw new Error("Could not get canvas context");let r=e.getImageData(0,0,t.width,t.height),n=[];for(let s=0;s<r.data.length;s+=4)n.push({R:r.data[s],G:r.data[s+1],B:r.data[s+2]});let o=this.performKMeans(n,this.options.maxColours),a=n.length;return{colours:o.map(s=>{let l=s.centroid,u={R:Math.round(Math.max(0,Math.min(255,l[0]))),G:Math.round(Math.max(0,Math.min(255,l[1]))),B:Math.round(Math.max(0,Math.min(255,l[2])))},h=s.cluster.length,m=h/a*100;return{rgb:u,pixels:h,percentage:m}}).filter(s=>s.percentage>=this.options.minPercentage).sort((s,l)=>l.percentage-s.percentage),metadata:{width:t.width,height:t.height,totalPixels:a,format:"canvas"}}}catch(e){throw new Error(`Canvas extraction failed: ${e.message}`)}}performKMeans(t,e){console.info(`K-means input: ${t.length} pixels, requesting ${e} clusters`);let r=[],n=0;for(let l of t)try{let u=A(l),h=L(u),m=D(h);if(isNaN(m.L)||isNaN(m.a)||isNaN(m.b)){n++;continue}r.push(m)}catch{n++;continue}if(n>0&&console.info(`NaN dropped: ${n}`),r.length===0)return console.warn("No valid Lab pixels, using RGB fallback"),this.simpleDominantColors(t,e);let o=Math.min(r.length,5e3),a=r.length>o?this.sampleArray(r,o):r;console.info(`Using ${a.length} sampled pixels`);let i=this.calculateOptimalK(a,e);if(console.info(`Adjusted k from ${e} to ${i}`),i<=1){let l=this.calculateAverageColor(t);return console.info("Single color case, using average:",l),[{centroid:[l.R,l.G,l.B],cluster:t.map(u=>[u.R,u.G,u.B])}]}let s=3;for(let l=0;l<s;l++)try{console.info(`K-means attempt ${l+1}/${s} with k=${i}`);let u=a.map(b=>[b.L,b.a,b.b]),h=new ht.default({K:i});h.cluster(u);let m=0,p=this.options.iterations||20;for(;h.step()&&m<p;){if(h.findClosestCentroids(),h.moveCentroids(),h.hasConverged()){console.info(`K-means converged in ${m} iterations`);break}m++}if(!h.centroids||h.centroids.length===0)throw new Error(`K-means returned empty result on attempt ${l+1}`);console.info(`K-means attempt ${l+1}: success with ${h.centroids.length} clusters in ${m} iterations`);let g=h.centroids.map((b,x)=>({centroid:b,cluster:h.clusters[x]||[]}));return this.convertLabClustersToRGB(g,t,r)}catch(u){if(console.warn(`K-means attempt ${l+1} failed:`,u.message),l===s-1)return console.warn("All k-means attempts failed, using fallback method"),this.simpleDominantColors(t,i)}return this.simpleDominantColors(t,i)}calculateOptimalK(t,e){let r=new Set;for(let o of t){let a=Math.round(o.L/4)*4,i=Math.round(o.a/2)*2,s=Math.round(o.b/2)*2;r.add(`${a},${i},${s}`)}let n=r.size;if(n<64)return Math.min(n,10,e);{let o=Math.round(Math.sqrt(n/2));return Math.max(6,Math.min(o,18,e))}}convertLabClustersToRGB(t,e,r){let n=[];for(let o of t){let[a,i,s]=o.centroid;try{let l={X:95.047*Math.pow((a+16)/116+i/500,3)/100,Y:100*Math.pow((a+16)/116,3)/100,Z:108.883*Math.pow((a+16)/116-s/200,3)/100},u=l.X*3.2406+l.Y*-1.5372+l.Z*-.4986,h=l.X*-.9689+l.Y*1.8758+l.Z*.0415,m=l.X*.0557+l.Y*-.204+l.Z*1.057,p=x=>(x=Math.max(0,Math.min(1,x)),x<=.0031308?12.92*x:1.055*Math.pow(x,1/2.4)-.055),g={R:Math.round(p(u)*255),G:Math.round(p(h)*255),B:Math.round(p(m)*255)},b=[];for(let x=0;x<r.length;x++){let d=r[x],f=Math.sqrt(Math.pow(d.L-a,2)+Math.pow(d.a-i,2)+Math.pow(d.b-s,2)),R=1/0,C=0;for(let B=0;B<e.length;B++){let w=Math.sqrt(Math.pow(e[B].R-g.R,2)+Math.pow(e[B].G-g.G,2)+Math.pow(e[B].B-g.B,2));w<R&&(R=w,C=B)}b.push([e[C].R,e[C].G,e[C].B])}n.push({centroid:[g.R,g.G,g.B],cluster:b.length>0?b:[[g.R,g.G,g.B]]})}catch(l){console.warn("Failed to convert Lab cluster to RGB:",l);let u=this.calculateAverageColor(e);n.push({centroid:[u.R,u.G,u.B],cluster:e.map(h=>[h.R,h.G,h.B])})}}return n}sampleArray(t,e){if(t.length<=e)return t;let r=t.length/e,n=[];for(let o=0;o<t.length;o+=r)n.push(t[Math.floor(o)]);return n.slice(0,e)}findClosestCluster(t,e){let r=1/0,n=e[0];for(let o of e){let a=Math.sqrt(Math.pow(t[0][0]-o[0],2)+Math.pow(t[0][1]-o[1],2)+Math.pow(t[0][2]-o[2],2));a<r&&(r=a,n=o)}return n}simpleDominantColors(t,e){console.info("Using simple color quantization fallback");let r=new Map,n=t.length;for(let i of t){let s={R:Math.floor(i.R/6)*6,G:Math.floor(i.G/6)*6,B:Math.floor(i.B/6)*6},l=`${s.R},${s.G},${s.B}`,u=r.get(l);if(u)u.count++;else{let h;try{let m=A(s),p=L(m);h=D(p)}catch{}r.set(l,{count:1,rgb:s,lab:h})}}let o=Array.from(r.entries()).filter(([i,s])=>s.lab!==void 0).map(([i,s])=>({key:i,rgb:s.rgb,lab:s.lab,count:s.count,percentage:s.count/n*100}));console.info(`Pre-merge: ${o.length} quantized colors`),o=this.mergeNearbyColors(o).filter(i=>i.lab!==void 0);let a=o.sort((i,s)=>s.count-i.count).slice(0,e);return console.info(`Post-merge: ${a.length} final colors`),a.map(i=>({centroid:[i.rgb.R,i.rgb.G,i.rgb.B],cluster:t.filter(s=>{let l={R:Math.floor(s.R/6)*6,G:Math.floor(s.G/6)*6,B:Math.floor(s.B/6)*6};return`${l.R},${l.G},${l.B}`===i.key}).map(s=>[s.R,s.G,s.B])}))}mergeNearbyColors(t){t.sort((a,i)=>i.percentage-a.percentage);let o=[];for(let a of t){let i=!1;if(a.percentage>=.75){o.push(a);continue}for(let s of o){if(!a.lab||!s.lab)continue;let l=Math.sqrt(Math.pow(a.lab.L-s.lab.L,2)+Math.pow(a.lab.a-s.lab.a,2)+Math.pow(a.lab.b-s.lab.b,2)),u=Math.abs(a.lab.a-s.lab.a),h=Math.abs(a.lab.b-s.lab.b);if(l<=1.5&&u<=8&&h<=8){let m=s.percentage+a.percentage,p=s.count+a.count;s.rgb={R:Math.round((s.rgb.R*s.count+a.rgb.R*a.count)/p),G:Math.round((s.rgb.G*s.count+a.rgb.G*a.count)/p),B:Math.round((s.rgb.B*s.count+a.rgb.B*a.count)/p)},s.lab={L:(s.lab.L*s.percentage+a.lab.L*a.percentage)/m,a:(s.lab.a*s.percentage+a.lab.a*a.percentage)/m,b:(s.lab.b*s.percentage+a.lab.b*a.percentage)/m},s.count=p,s.percentage=m,i=!0;break}}i||o.push(a)}return o}calculateAverageColor(t){if(t.length===0)return{R:0,G:0,B:0};let e=t.reduce((r,n)=>({R:r.R+n.R,G:r.G+n.G,B:r.B+n.B}),{R:0,G:0,B:0});return{R:Math.round(e.R/t.length),G:Math.round(e.G/t.length),B:Math.round(e.B/t.length)}}};var O=class{constructor(t={}){this.options={maxColours:t.maxColours??20,minPercentage:t.minPercentage??.5}}async extract(t,e){let r=Date.now();try{let n=new TextDecoder("utf-8").decode(t);console.info(`[SVG] Parsing SVG (${t.byteLength} bytes)`);let o=this.parseSVGDimensions(n),a=o.width&&o.height?o.width*o.height:1e6,i=this.extractColors(n),s=Array.from(i.values()).reduce((h,m)=>h+m,0),l=Array.from(i.entries()).map(([h,m])=>{let p=this.hexToRgb(h),g=m/s*100;return{rgb:p,percentage:g,pixels:Math.round(g/100*a)}}).filter(h=>h.percentage>=this.options.minPercentage).sort((h,m)=>m.percentage-h.percentage).slice(0,this.options.maxColours),u=Date.now()-r;return console.info(`[SVG] Extracted ${l.length} colors in ${u}ms`),{colours:l,metadata:{width:o.width,height:o.height,totalPixels:a,format:e}}}catch(n){throw new Error(`SVG extraction failed: ${n.message}`)}}parseSVGDimensions(t){let e=t.match(/viewBox=["']([^"']+)["']/i);if(e){let[,,,o,a]=e[1].split(/\s+/).map(parseFloat);if(!isNaN(o)&&!isNaN(a))return{width:o,height:a}}let r=t.match(/width=["']([^"']+)["']/i),n=t.match(/height=["']([^"']+)["']/i);if(r&&n){let o=parseFloat(r[1]),a=parseFloat(n[1]);if(!isNaN(o)&&!isNaN(a))return{width:o,height:a}}return{width:null,height:null}}extractColors(t){let e=new Map,r=t.matchAll(/fill=["']([^"']+)["']/gi);for(let i of r){let s=this.normalizeColor(i[1]);s&&e.set(s,(e.get(s)||0)+1)}let n=t.matchAll(/stroke=["']([^"']+)["']/gi);for(let i of n){let s=this.normalizeColor(i[1]);s&&e.set(s,(e.get(s)||0)+.5)}let o=t.matchAll(/style=["']([^"']+)["']/gi);for(let i of o){let s=i[1],l=s.match(/fill:\s*([^;]+)/i);if(l){let h=this.normalizeColor(l[1]);h&&e.set(h,(e.get(h)||0)+1)}let u=s.match(/stroke:\s*([^;]+)/i);if(u){let h=this.normalizeColor(u[1]);h&&e.set(h,(e.get(h)||0)+.5)}}let a=t.matchAll(/<style[^>]*>([\s\S]*?)<\/style>/gi);for(let i of a){let s=i[1],l=s.matchAll(/fill:\s*([^;}\s]+)/gi);for(let h of l){let m=this.normalizeColor(h[1]);m&&e.set(m,(e.get(m)||0)+1)}let u=s.matchAll(/stroke:\s*([^;}\s]+)/gi);for(let h of u){let m=this.normalizeColor(h[1]);m&&e.set(m,(e.get(m)||0)+.5)}}return e}normalizeColor(t){let e=t.trim().toLowerCase();if(e==="none"||e==="transparent"||e==="currentcolor")return null;if(e.match(/^#[0-9a-f]{3,6}$/))return e.length===4?`#${e[1]}${e[1]}${e[2]}${e[2]}${e[3]}${e[3]}`:e;let r=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(r){let o=parseInt(r[1],10),a=parseInt(r[2],10),i=parseInt(r[3],10);return this.rgbToHex({R:o,G:a,B:i})}let n={white:"#ffffff",black:"#000000",red:"#ff0000",green:"#008000",blue:"#0000ff",yellow:"#ffff00",cyan:"#00ffff",magenta:"#ff00ff",gray:"#808080",grey:"#808080",orange:"#ffa500",purple:"#800080",brown:"#a52a2a",pink:"#ffc0cb"};return n[e]?n[e]:null}hexToRgb(t){let e=t.replace("#",""),r=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),o=parseInt(e.substring(4,6),16);return{R:r,G:n,B:o}}rgbToHex(t){let e=r=>Math.round(Math.max(0,Math.min(255,r))).toString(16).padStart(2,"0");return`#${e(t.R)}${e(t.G)}${e(t.B)}`}};var V=class{constructor(t={}){this.options={whitePoint:t.whitePoint??"D65",gamma:t.gamma??2.4}}rgbToLab(t){return lt(t)}rgbToHex(t){let e=r=>Math.round(Math.max(0,Math.min(255,r))).toString(16).padStart(2,"0");return`#${e(t.R)}${e(t.G)}${e(t.B)}`}hexToRgb(t){let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!e)throw new Error(`Invalid hex color: ${t}`);return{R:parseInt(e[1],16),G:parseInt(e[2],16),B:parseInt(e[3],16)}}calculateDeltaE(t,e){let r=t.L-e.L,n=t.a-e.a,o=t.b-e.b;return Math.sqrt(r*r+n*n+o*o)}deduplicate(t,e=5){let r=[];for(let n of t)if(!r.some(a=>this.calculateDeltaE(a.lab,n.lab)<e))r.push(n);else{let a=r.find(i=>this.calculateDeltaE(i.lab,n.lab)<e);a&&(a.areaPct+=n.areaPct,a.pageIds&&n.pageIds&&(a.pageIds=[...new Set([...a.pageIds,...n.pageIds])]))}return r}normalizeAreas(t){let e=t.reduce((r,n)=>r+n.areaPct,0);return e===0?t:t.map(r=>({...r,areaPct:r.areaPct/e*100}))}filterInsignificant(t,e=1,r=!0,n=!0){return t.filter(o=>!(o.areaPct<e||r&&o.lab.L>95||n&&o.lab.L<5))}sortByImportance(t){return t.sort((e,r)=>{if(Math.abs(e.areaPct-r.areaPct)>1)return r.areaPct-e.areaPct;let n=Math.sqrt(e.lab.a*e.lab.a+e.lab.b*e.lab.b);return Math.sqrt(r.lab.a*r.lab.a+r.lab.b*r.lab.b)-n})}};function q(c,t){let e=new V().rgbToHex(c),r=Array.from(e).reduce((n,o)=>(n=(n<<5)-n+o.charCodeAt(0),n&n),0);return`${t}_${Math.abs(r).toString(36)}`}function mt(c){let t=c.toLowerCase().split(".").pop();if(!t)return{isValid:!1,type:null};let e=["png","jpg","jpeg","webp"],r=["svg"];return["pdf"].includes(t)?{isValid:!0,type:"pdf",format:t}:r.includes(t)?{isValid:!0,type:"svg",format:t}:e.includes(t)?{isValid:!0,type:"image",format:t}:{isValid:!1,type:null}}function pt(c,t){return t==="pdf"?c<2*1048576?"low":c<10*1048576?"medium":"high":t==="svg"?c<5*1048576?"low":c<15*1048576?"medium":"high":c<1*1048576?"low":c<5*1048576?"medium":"high"}var nt=class{constructor(t={}){this.cache=new Map;this.options={defaultTTL:t.defaultTTL??1800*1e3,maxEntries:t.maxEntries??100,cleanupInterval:t.cleanupInterval??300*1e3},this.startCleanup()}set(t,e,r){let n={data:e,timestamp:Date.now(),ttl:r??this.options.defaultTTL,hits:0};this.cache.set(t,n),this.evictOldest()}get(t){let e=this.cache.get(t);return e?Date.now()-e.timestamp>e.ttl?(this.cache.delete(t),null):(e.hits++,e.data):null}has(t){let e=this.cache.get(t);return e?Date.now()-e.timestamp>e.ttl?(this.cache.delete(t),!1):!0:!1}delete(t){return this.cache.delete(t)}clear(){this.cache.clear()}size(){return this.cache.size}getStats(){let t=Array.from(this.cache.values()),e=Date.now(),r=t.reduce((i,s)=>i+s.hits,0),n=t.reduce((i,s)=>i+(e-s.timestamp),0),o=t.length>0?n/t.length:0,a=t.length>0?r/t.length:0;return{entries:t.length,totalHits:r,averageAge:o,hitRate:a}}evictOldest(){if(this.cache.size<=this.options.maxEntries)return;let t="",e=Date.now();for(let[r,n]of this.cache)n.timestamp<e&&(e=n.timestamp,t=r);t&&this.cache.delete(t)}startCleanup(){this.cleanupTimer=setInterval(()=>{this.cleanup()},this.options.cleanupInterval)}cleanup(){let t=Date.now(),e=[];for(let[r,n]of this.cache)t-n.timestamp>n.ttl&&e.push(r);for(let r of e)this.cache.delete(r)}destroy(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.clear()}},et=null;function dt(){return et||(et=new nt({defaultTTL:3600*1e3,maxEntries:50,cleanupInterval:600*1e3})),et}function ft(c,t,e={}){let r=JSON.stringify(e),n=`${c}-${t}-${r}`,o=0;for(let a=0;a<n.length;a++){let i=n.charCodeAt(a);o=(o<<5)-o+i,o=o&o}return Math.abs(o).toString(36)}var X=class{constructor(t={}){this.options={maxColours:t.maxColours??15,minAreaPct:t.minAreaPct??1,combineStrategy:t.combineStrategy??"merge",rasterFallback:t.rasterFallback??!0,pdfOptions:{minFrequency:3,tolerance:8,...t.pdfOptions},rasterOptions:{resampleSize:400,iterations:15,...t.rasterOptions}},this.converter=new V,this.rasterExtractor=new H({maxColours:this.options.maxColours,minPercentage:this.options.minAreaPct,...this.options.rasterOptions}),this.svgExtractor=new O({maxColours:this.options.maxColours,minPercentage:this.options.minAreaPct})}async extract(t,e,r){let n=Date.now(),o=mt(e),a=pt(t.byteLength,o.type),i=[],s=[];if(!o.isValid)throw new Error(`Unsupported file type: ${e}`);let l=dt(),u=ft(e,t.byteLength,this.options),h=l.get(u);if(h)return r?.updateProgress("complete",100,"Using cached result"),h;r?.updateProgress("extracting",10,"Starting color extraction...");try{let m=[],p=[],g=[];if(o.type==="pdf"&&(r?.updateProgress("extracting",25,"Skipping server PDF processing - client handles extraction..."),i.push("PDF processing handled client-side. Server extraction skipped to avoid canvas dependencies."),console.info("Skipping server-side PDF processing - relying on client-side extraction")),o.type==="svg")try{r?.updateProgress("extracting",30,"Parsing SVG colors..."),g=(await this.svgExtractor.extract(t,o.format)).colours.map(f=>({id:q(f.rgb,"svg"),rgb:f.rgb,lab:this.converter.rgbToLab(f.rgb),areaPct:f.percentage,source:"svg",metadata:{pixels:f.pixels,percentage:f.percentage}})),s.push("svg"),g.length===0&&i.push("No significant colors found in SVG")}catch(d){throw new Error(`SVG extraction failed: ${d.message}`)}if(o.type==="image")try{r?.updateProgress("extracting",40,"Analyzing raster image colors..."),p=(await this.rasterExtractor.extract(t,o.format)).colours.map(f=>({id:q(f.rgb,"raster"),rgb:f.rgb,lab:this.converter.rgbToLab(f.rgb),areaPct:f.percentage,source:"raster",metadata:{pixels:f.pixels,percentage:f.percentage}})),s.push("raster"),p.length===0&&i.push("No significant colors found in raster image")}catch(d){throw new Error(`Image extraction failed: ${d.message}`)}r?.updateProgress("processing",70,"Combining and filtering colors...");let b=[...m,...g,...p];b=this.converter.filterInsignificant(b,this.options.minAreaPct),b=this.converter.sortByImportance(b),b.length>this.options.maxColours&&(b=b.slice(0,this.options.maxColours),i.push(`Truncated to ${this.options.maxColours} most significant colors`)),b.length===0&&(i.push("No colors extracted, using fallback"),b=[{id:q({R:128,G:128,B:128},"fallback"),rgb:{R:128,G:128,B:128},lab:this.converter.rgbToLab({R:128,G:128,B:128}),areaPct:100,source:"raster"}]);let x={palette:b,metadata:{filename:e,fileSize:t.byteLength,fileType:o.type,extractionTime:Date.now()-n,complexity:a,sources:s,totalColours:{pdf:m.length||void 0,svg:g.length||void 0,raster:p.length||void 0,combined:b.length}},warnings:i.length>0?i:void 0};return r?.updateProgress("caching",90,"Caching extraction result..."),l.set(u,x,3600*1e3),r?.complete(),x}catch(m){throw new Error(`Palette extraction failed: ${m.message}`)}}};function P(c,t){let{L:e,a:r,b:n}=c,{L:o,a,b:i}=t,s=1,l=1,u=1,h=Math.sqrt(r*r+n*n),m=Math.sqrt(a*a+i*i),p=(h+m)/2,g=.5*(1-Math.sqrt(Math.pow(p,7)/(Math.pow(p,7)+Math.pow(25,7)))),b=(1+g)*r,x=(1+g)*a,d=Math.sqrt(b*b+n*n),f=Math.sqrt(x*x+i*i),R=Math.atan2(n,b)*180/Math.PI;R<0&&(R+=360);let C=Math.atan2(i,x)*180/Math.PI;C<0&&(C+=360);let B=o-e,w=f-d,v;if(d*f===0)v=0;else{let $=C-R;Math.abs($)<=180?v=$:$>180?v=$-360:v=$+360}let M=2*Math.sqrt(d*f)*Math.sin(v*Math.PI/360),E=(e+o)/2,G=(d+f)/2,y;if(d*f===0)y=R+C;else{let $=Math.abs(R-C),z=R+C;$<=180?y=z/2:z<360?y=(z+360)/2:y=(z-360)/2}let S=1-.17*Math.cos((y-30)*Math.PI/180)+.24*Math.cos(2*y*Math.PI/180)+.32*Math.cos((3*y+6)*Math.PI/180)-.2*Math.cos((4*y-63)*Math.PI/180),N=30*Math.exp(-Math.pow((y-275)/25,2)),Mt=2*Math.sqrt(Math.pow(G,7)/(Math.pow(G,7)+Math.pow(25,7))),Et=1+.015*Math.pow(E-50,2)/Math.sqrt(20+Math.pow(E-50,2)),at=1+.045*G,st=1+.015*G*S,yt=-Math.sin(2*N*Math.PI/180)*Mt;return Math.sqrt(Math.pow(B/(s*Et),2)+Math.pow(w/(l*at),2)+Math.pow(M/(u*st),2)+yt*(w/(l*at))*(M/(u*st)))}function gt(c){return c.map(t=>({...t,linearRGB:A({R:t.R,G:t.G,B:t.B})}))}function T(c){let t=0,e=0,r=0,n=0;for(let{color:o,weight:a}of c)t+=o.R*a,e+=o.G*a,r+=o.B*a,n+=a;return n===0?{R:0,G:0,B:0}:{R:t/n,G:e/n,B:r/n}}function F(c){let t=c.reduce((e,r)=>e+r,0);return t===0?c:c.map(e=>e/t)}function bt(c,t){return t===0?Math.abs(c):bt(t,c%t)}function Y(c){return c.length===0?1:c.length===1?Math.abs(c[0]):c.reduce((t,e)=>bt(t,e),0)||1}function rt(c){return c.reduce((t,e,r,n)=>e>n[t]?r:t,0)}function At(c,t){let e=Y(c),r=c.map(l=>Math.max(1,Math.round(l/e))),n=t.map((l,u)=>({c:l,w:r[u]})).sort((l,u)=>l.c.localeCompare(u.c)),o=n.map(l=>l.c),a=n.map(l=>l.w),i=a.reduce((l,u)=>l+u,0),s=`parts:${o.map((l,u)=>`${l}:${a[u]}`).join("|")}`;return{codes:o,parts:a,total:i,key:s}}function _t(c){let e=c.map(({code:l,pct:u})=>({c:l,n:Math.round(u*2400)})).filter(l=>l.n>0),r=Y(e.map(l=>l.n)),n=e.map(l=>({c:l.c,n:Math.max(1,Math.round(l.n/r))}));n.sort((l,u)=>l.c.localeCompare(u.c));let o=`pct:${n.map(l=>`${l.c}:${l.n}`).join("|")}`,a=n.reduce((l,u)=>l+u.n,0),i=n.map(l=>l.n/a);return{codes:n.map(l=>l.c),weights:i,key:o}}function jt(c){let t=(e,r)=>Math.round(e/r);return`lab:${t(c.L,.75)}:${t(c.a,1)}:${t(c.b,1)}`}function kt(c,t){let e=c.mode==="parts"&&c.parts?c.parts.codes.length:c.components.length,r=t.mode==="parts"&&t.parts?t.parts.codes.length:t.components.length;if(e!==r)return e<r;let n=c.mode==="parts"&&c.parts?c.parts.total:1/0,o=t.mode==="parts"&&t.parts?t.parts.total:1/0;return n!==o?n<o:c.deltaE<t.deltaE}function W(c){let t=c.mode==="parts"&&c.parts?c.parts.codes.length:c.components.length,e=c.mode==="parts"&&c.parts?c.parts.total:9999;return t*1e3+e+c.deltaE}function Rt(c){let t=new Map;for(let n of c){let o=n.mode==="parts"&&n.parts?At(n.parts.parts,n.parts.codes).key:_t(n.components).key,a=t.get(o);(!a||kt(n,a))&&t.set(o,n)}let e=new Map;for(let n of Array.from(t.values())){let o=jt(n.lab),a=e.get(o)||[];a.push(n),e.set(o,a)}let r=[];for(let n of Array.from(e.values()))n.sort((o,a)=>W(o)-W(a)),r.push(n[0]);return r.sort((n,o)=>W(n)-W(o))}function xt(c,t,e=.75){let r=[],n=[...c],o=(a,i)=>Math.hypot(a.lab.L-i.lab.L,a.lab.a-i.lab.a,a.lab.b-i.lab.b);for(;r.length<t&&n.length>0;){let a=0,i=1/0;for(let s=0;s<n.length;s++){let l=n[s],u=l.deltaE,h=r.length>0?Math.min(...r.map(p=>o(l,p))):1e3,m=e*u-(1-e)*h;m<i&&(i=m,a=s)}r.push(n.splice(a,1)[0])}return r}function Vt(c,t,e,r={separation:45,closeness:12,penalty:2}){let n=P(c,t),o=P(c,e),a=P(t,e);return n>r.separation&&Math.min(o,a)>r.closeness?r.penalty:0}function Ft(c,t={dominant:.7,adjuster:.25,dominantBonus:-.3,adjusterBonus:-.2}){let e=[...c].sort((n,o)=>o-n),r=0;return e[0]>=t.dominant&&(r+=t.dominantBonus),e.length>1&&e[1]<=t.adjuster&&(r+=t.adjusterBonus),r}function Nt(c,t,e,r,n={topN:6,minWeight:.6,bonus:-.5}){let o=P(c,t),a=[...r].sort((s,l)=>s-l);return o<=a[n.topN-1]&&e>=n.minWeight?n.bonus:0}function _(c,t,e){let r=0;if(c.length>=2)for(let o=0;o<c.length;o++)for(let a=o+1;a<c.length;a++){let i=Vt(c[o].lab,c[a].lab,t);r+=c.length===3?i*.5:i}let n=c.map(o=>o.weight);if(r+=Ft(n),c.length>0){let o=c.reduce((a,i)=>i.weight>a.weight?i:a);r+=Nt(o.lab,t,o.weight,e)}return r}function zt(c,t,e,r){let{total:n,minPer:o,maxAttempts:a=3}=r,i=Object.keys(c).filter(M=>c[M]>0);if(i.length===0)return null;let s=i.map(M=>Math.max(o,Math.round(c[M]*n))),l=s.reduce((M,E)=>M+E,0),u=0;for(;l!==n&&u<a*10;){if(n-l>0){let E=s.map((y,S)=>c[i[S]]*n-y),G=rt(E);s[G]++}else{let E=s.map((y,S)=>y-c[i[S]]*n),G=rt(E);s[G]>o&&s[G]--}l=s.reduce((E,G)=>E+G,0),u++}if(l!==n)return null;let h=[...s],m=Ct(i,s,t,e);for(let M=0;M<5;M++){let E=!1;for(let G=0;G<i.length;G++)for(let y=0;y<i.length;y++){if(G===y||s[G]<=o)continue;let S=[...s];S[G]--,S[y]++;let N=Ct(i,S,t,e);N<m&&(h=[...S],m=N,E=!0)}if(!E)break;s=[...h]}let p=Y(h),g=h.map(M=>M/p),b=g.reduce((M,E)=>M+E,0),x=F(g),d={},f={};i.forEach((M,E)=>{d[M]=g[E],f[M]=x[E]});let R=i.map((M,E)=>({color:t.find(y=>y.code===M).linearRGB,weight:x[E]})),C=T(R),B=I(C),w=L(C),v=D(w);return{parts:d,weights:f,total:b,deltaE:P(e,v),lab:v,rgb:B}}function Ct(c,t,e,r){let n=F(t),o=c.map((l,u)=>({color:e.find(m=>m.code===l).linearRGB,weight:n[u]})),a=T(o),i=L(a),s=D(i);return P(r,s)}function Bt(c,t,e,r={totals:[9,12,15,18],minPer:1,maxDeltaEPenalty:.8}){let n=null;for(let o of r.totals){let a=zt(c,t,e,{total:o,minPer:r.minPer});if(a&&((!n||a.deltaE<r.maxDeltaEPenalty||a.deltaE<n.deltaE)&&(n=a),a.deltaE<r.maxDeltaEPenalty))break}return n}var Z=class{constructor(t,e){this.colours=t;this.constraints=e;this.twoWayCache=[];this.singleDistances=[];this.enhancedColours=gt(t),this.precomputeTwoWayBlends()}getHueSector(t){let r=(Math.atan2(t.b,t.a)*180/Math.PI%360+360)%360;return Math.floor(r/60)}toDedupeRecipe(t){return{components:t.components,mode:this.constraints.mode,parts:t.parts&&t.total?{codes:Object.keys(t.parts),parts:Object.values(t.parts),total:t.total}:void 0,lab:t.lab,deltaE:t.deltaE,weights:t.weights}}fromDedupeRecipe(t){let e=t.parts?t.parts.codes.reduce((n,o,a)=>(n[o]=t.parts.parts[a],n),{}):void 0,r=this.calculateRGBFromWeights(t.weights);return{components:t.components,weights:t.weights,parts:e,total:t.parts?.total,lab:t.lab,rgb:r,deltaE:t.deltaE,baseDeltaE:t.deltaE,note:t.mode==="parts"?"Parts blend":"Percentage blend",reasoning:"Generated by enhanced solver"}}calculateRGBFromWeights(t){let e=Object.entries(t).map(([n,o])=>{let a=this.enhancedColours.find(i=>i.code===n);return a?{color:a.linearRGB,weight:o}:{color:{R:.5,G:.5,B:.5},weight:o}});if(e.length===0)return{R:128,G:128,B:128};let r=T(e);return I(r)}solve(t,e=5){let r=[];if(this.singleDistances=this.enhancedColours.map(l=>P(t,{L:l.L,a:l.a,b:l.b})),this.constraints.maxComponents>=1){let l=this.solveSingleComponents(t);r.push(...l)}if(this.constraints.maxComponents>=2){let l=this.solveTwoWayBlends(t);r.push(...l)}if(this.constraints.maxComponents>=3){let l=this.solveThreeWayBlendsWithHueDiversity(t);r.push(...l)}if(r.length<e*3&&this.constraints.maxComponents<3){let l=this.autoExpandSearch(t,e*2);r.push(...l)}let o=r.map(l=>this.convertToPartsIfNeeded(l,t)).map(l=>this.toDedupeRecipe(l)),a=Rt(o);return xt(a,e*2,.75).slice(0,e).map(l=>this.fromDedupeRecipe(l))}autoExpandSearch(t,e){let r=[];if(this.constraints.maxComponents<3){let n=this.constraints.maxComponents;this.constraints.maxComponents=3;let o=this.solveThreeWayBlendsWithHueDiversity(t);r.push(...o.slice(0,Math.ceil(e/2))),this.constraints.maxComponents=n}if(r.length<e){let n=this.constraints.minPct,o=Math.max(.05,this.constraints.minPct-.03);this.constraints.minPct=o;for(let a of this.twoWayCache.slice(0,e*2))if(a.p>=o&&1-a.p>=o){a.deltaE=P(t,a.lab);let i=this.enhancedColours[a.i],s=this.enhancedColours[a.j],l=_([{lab:{L:i.L,a:i.a,b:i.b},weight:a.p},{lab:{L:s.L,a:s.a,b:s.b},weight:1-a.p}],t,this.singleDistances);a.adjustedDeltaE=a.deltaE+l;let u=a.p>=.6?i:a.p<=.4?s:null,h=u?`Relaxed ${u.name} with ${u===i?s.name:i.name} adjustment`:`Relaxed balanced mix of ${i.name} and ${s.name}`;if(r.push({components:[{code:i.code,pct:a.p},{code:s.code,pct:1-a.p}],weights:{[i.code]:a.p,[s.code]:1-a.p},lab:a.lab,rgb:I(T([{color:i.linearRGB,weight:a.p},{color:s.linearRGB,weight:1-a.p}])),deltaE:a.adjustedDeltaE,baseDeltaE:a.deltaE,note:"2-component expanded blend",reasoning:h}),r.length>=e)break}this.constraints.minPct=n}return r.slice(0,e)}precomputeTwoWayBlends(){let{minPct:t}=this.constraints,e=1-t,r=Math.max(.04,this.constraints.stepPct*2);for(let n=0;n<this.enhancedColours.length;n++)for(let o=n+1;o<this.enhancedColours.length;o++){let a=this.enhancedColours[n],i=this.enhancedColours[o];for(let s=t;s<=e;s+=r){let l=T([{color:a.linearRGB,weight:s},{color:i.linearRGB,weight:1-s}]),u=L(l),h=D(u);this.twoWayCache.push({i:n,j:o,p:s,lab:h,deltaE:0,adjustedDeltaE:0})}}}refineTopCandidates(t,e,r=20){let n=[],o=Math.min(.01,this.constraints.stepPct);for(let a of t.slice(0,r)){let i=this.enhancedColours[a.i],s=this.enhancedColours[a.j],l=.08,u=Math.max(this.constraints.minPct,a.p-l),h=Math.min(1-this.constraints.minPct,a.p+l),m=a;for(let p=u;p<=h;p+=o){let g=T([{color:i.linearRGB,weight:p},{color:s.linearRGB,weight:1-p}]),b=L(g),x=D(b),d=P(e,x),f=_([{lab:{L:i.L,a:i.a,b:i.b},weight:p},{lab:{L:s.L,a:s.a,b:s.b},weight:1-p}],e,this.singleDistances),R=d+f;R<m.adjustedDeltaE&&(m={i:a.i,j:a.j,p,lab:x,deltaE:d,adjustedDeltaE:R})}n.push(m)}return n.sort((a,i)=>a.adjustedDeltaE-i.adjustedDeltaE)}solveSingleComponents(t){let e=[];for(let r=0;r<this.enhancedColours.length;r++){let n=this.enhancedColours[r],o={L:n.L,a:n.a,b:n.b},a=P(t,o);e.push({components:[{code:n.code,pct:1}],weights:{[n.code]:1},lab:o,rgb:{R:n.R,G:n.G,B:n.B},deltaE:a,baseDeltaE:a,note:"Single component",reasoning:`Direct match with ${n.name}`})}return e.sort((r,n)=>r.deltaE-n.deltaE).slice(0,2)}solveTwoWayBlends(t){for(let n of this.twoWayCache){n.deltaE=P(t,n.lab);let o=this.enhancedColours[n.i],a=this.enhancedColours[n.j],i=_([{lab:{L:o.L,a:o.a,b:o.b},weight:n.p},{lab:{L:a.L,a:a.a,b:a.b},weight:1-n.p}],t,this.singleDistances);n.adjustedDeltaE=n.deltaE+i}let e=this.twoWayCache.slice().sort((n,o)=>n.adjustedDeltaE-o.adjustedDeltaE).slice(0,30);return this.refineTopCandidates(e,t,15).slice(0,10).map(n=>{let o=this.enhancedColours[n.i],a=this.enhancedColours[n.j],i=n.p>=.6?o:n.p<=.4?a:null,s=i?`Anchor ${i.name} with ${i===o?a.name:o.name} adjustment`:`Balanced mix of ${o.name} and ${a.name}`;return{components:[{code:o.code,pct:n.p},{code:a.code,pct:1-n.p}],weights:{[o.code]:n.p,[a.code]:1-n.p},lab:n.lab,rgb:I(T([{color:o.linearRGB,weight:n.p},{color:a.linearRGB,weight:1-n.p}])),deltaE:n.adjustedDeltaE,baseDeltaE:n.deltaE,note:"2-component blend",reasoning:s}})}solveThreeWayBlendsWithHueDiversity(t){let e=[],r=new Map;for(let o of this.twoWayCache){o.deltaE=P(t,o.lab);let a=this.enhancedColours[o.i],i=this.enhancedColours[o.j],s=_([{lab:{L:a.L,a:a.a,b:a.b},weight:o.p},{lab:{L:i.L,a:i.a,b:i.b},weight:1-o.p}],t,this.singleDistances);o.adjustedDeltaE=o.deltaE+s;let l=this.getHueSector(o.lab),u=r.get(l)||[];u.push(o),r.set(l,u)}let n=[];for(let o of Array.from(r.values()))o.sort((a,i)=>a.adjustedDeltaE-i.adjustedDeltaE),n.push(...o.slice(0,4));if(n.length<24){let o=Array.from(r.values()).flat();o.sort((i,s)=>i.adjustedDeltaE-s.adjustedDeltaE);let a=30-n.length;n.push(...o.slice(0,a))}return this.generateThreeWayFromSeeds(n,t)}generateThreeWayFromSeeds(t,e){let r=[];for(let n of t){let o=[n.i,n.j];for(let a=0;a<this.enhancedColours.length;a++){if(o.includes(a))continue;let i=this.enhancedColours[a];for(let s=this.constraints.minPct;s<=1-2*this.constraints.minPct;s+=this.constraints.stepPct*2){let l=1-s,u=Math.max(this.constraints.minPct,n.p*l),h=l-u;if(h<this.constraints.minPct)continue;let m=F([u,h,s]),[p,g,b]=m,x=T([{color:this.enhancedColours[n.i].linearRGB,weight:p},{color:this.enhancedColours[n.j].linearRGB,weight:g},{color:i.linearRGB,weight:b}]),d=L(x),f=D(d),R=P(e,f),C=_([{lab:{L:this.enhancedColours[n.i].L,a:this.enhancedColours[n.i].a,b:this.enhancedColours[n.i].b},weight:p},{lab:{L:this.enhancedColours[n.j].L,a:this.enhancedColours[n.j].a,b:this.enhancedColours[n.j].b},weight:g},{lab:{L:i.L,a:i.a,b:i.b},weight:b}],e,this.singleDistances),B=R+C;r.push({components:[{code:this.enhancedColours[n.i].code,pct:p},{code:this.enhancedColours[n.j].code,pct:g},{code:i.code,pct:b}],weights:{[this.enhancedColours[n.i].code]:p,[this.enhancedColours[n.j].code]:g,[i.code]:b},lab:f,rgb:I(x),deltaE:B,baseDeltaE:R,note:"3-component blend",reasoning:"Refined blend with three components"})}}}return r.sort((n,o)=>n.deltaE-o.deltaE).slice(0,5)}convertToPartsIfNeeded(t,e){if(this.constraints.mode!=="parts"||!this.constraints.parts?.enabled)return t;let r=Bt(t.weights,this.enhancedColours,e,{totals:this.constraints.parts.total?[this.constraints.parts.total]:[9,12,15],minPer:this.constraints.parts.minPer||1,maxDeltaEPenalty:.8});return r?{...t,parts:r.parts,total:r.total,weights:r.weights,lab:r.lab,rgb:r.rgb,deltaE:r.deltaE,note:t.note+` (${r.total} parts total)`,reasoning:t.reasoning+` - Snapped to ${r.total} parts with \u0394E ${(r.deltaE-t.baseDeltaE).toFixed(2)} penalty`}:t}};var ot=[{code:"RH01",name:"Standard Red",hex:"#B71E2D",R:183,G:30,B:45,L:39.4,a:58.5,b:29},{code:"RH02",name:"Bright Red",hex:"#E31D25",R:227,G:29,B:37,L:47.4,a:70.1,b:44},{code:"RH10",name:"Standard Green",hex:"#006B3F",R:0,G:107,B:63,L:40.5,a:-42.2,b:17.9},{code:"RH11",name:"Bright Green",hex:"#4BAA34",R:75,G:170,B:52,L:62.1,a:-47.7,b:47.2},{code:"RH12",name:"Dark Green",hex:"#006747",R:0,G:103,B:71,L:39.6,a:-38.3,b:13.1},{code:"RH20",name:"Standard Blue",hex:"#1B4F9C",R:27,G:79,B:156,L:36.4,a:14.2,b:-46.7},{code:"RH21",name:"Purple",hex:"#662D91",R:102,G:45,B:145,L:31.5,a:41.9,b:-40.9},{code:"RH22",name:"Light Blue",hex:"#0091D7",R:0,G:145,B:215,L:55.3,a:-19.1,b:-37.3},{code:"RH23",name:"Azure",hex:"#0076B6",R:0,G:118,B:182,L:47.7,a:-4.8,b:-34.8},{code:"RH26",name:"Turquoise",hex:"#00A499",R:0,G:164,B:153,L:58.8,a:-38.4,b:-3},{code:"RH30",name:"Standard Beige",hex:"#D4B585",R:212,G:181,B:133,L:75.2,a:3.8,b:24.8},{code:"RH31",name:"Cream",hex:"#F2E6C8",R:242,G:230,B:200,L:91.8,a:-.5,b:12.5},{code:"RH32",name:"Brown",hex:"#754C29",R:117,G:76,B:41,L:40,a:15.9,b:27.1},{code:"RH90",name:"Funky Pink",hex:"#e8457e",R:232,G:69,B:126,L:55,a:66.1,b:4.9},{code:"RH40",name:"Mustard Yellow",hex:"#C6972D",R:198,G:151,B:45,L:66,a:8.4,b:56.3},{code:"RH41",name:"Bright Yellow",hex:"#FFD100",R:255,G:209,B:0,L:86.9,a:-1,b:90.6},{code:"RH50",name:"Orange",hex:"#F47920",R:244,G:121,B:32,L:63.2,a:49.8,b:60.2},{code:"RH60",name:"Dark Grey",hex:"#4D4F53",R:77,G:79,B:83,L:34.1,a:-.4,b:-2.4},{code:"RH61",name:"Light Grey",hex:"#A7A8AA",R:167,G:168,B:170,L:69,a:-.5,b:-1},{code:"RH65",name:"Pale Grey",hex:"#DCDDDE",R:220,G:221,B:222,L:87.6,a:-.2,b:-.7},{code:"RH70",name:"Black",hex:"#101820",R:16,G:24,B:32,L:9.1,a:-.3,b:-6.3}];async function Ot(c,t){if(c.method!=="POST")return t.status(405).json({success:!1,error:"Method not allowed. Use POST."});try{let{svg_url:e,job_id:r,max_colors:n=8,max_components:o=2}=c.body;if(!e)return t.status(400).json({success:!1,error:"Missing required field: svg_url"});console.log("[BLEND-RECIPES] Starting color extraction for job:",r),console.log("[BLEND-RECIPES] SVG URL:",e),console.log("[BLEND-RECIPES] Max colors:",n,"Max components:",o);let a=Date.now();console.log("[BLEND-RECIPES] Fetching SVG from URL...");let i=await fetch(e);if(!i.ok)throw new Error(`Failed to fetch SVG: ${i.status} ${i.statusText}`);let s=await i.arrayBuffer();console.log(`[BLEND-RECIPES] SVG fetched (${s.byteLength} bytes)`),console.log("[BLEND-RECIPES] Extracting colors...");let u=await new X({maxColours:n,minAreaPct:1,rasterOptions:{resampleSize:400,iterations:15}}).extract(s,"design.svg"),h=Date.now()-a;if(console.log(`[BLEND-RECIPES] Extracted ${u.palette.length} colors in ${h}ms`),u.palette.length===0)return t.status(200).json({success:!0,colors:[],recipes:[],message:"No significant colors found in SVG (all colors below 1% coverage)"});console.log("[BLEND-RECIPES] Initializing blend solver...");let m=new Z(ot,{maxComponents:o,stepPct:.04,minPct:.1,mode:"parts",parts:{enabled:!0,total:12,minPer:1},preferAnchor:!0});console.log("[BLEND-RECIPES] Generating blend recipes...");let p=[],g=Date.now();for(let f=0;f<u.palette.length;f++){let R=u.palette[f];console.log(`[BLEND-RECIPES]   Color ${f+1}/${u.palette.length}: RGB(${R.rgb.R}, ${R.rgb.G}, ${R.rgb.B}) - ${R.areaPct.toFixed(1)}%`);let C=m.solve(R.lab,3),B=C.map(w=>({parts:w.parts||{},total:w.total||0,deltaE:w.deltaE,quality:w.deltaE<1?"Excellent":w.deltaE<2?"Good":"Fair",resultRgb:w.rgb,components:w.components.map(v=>({code:v.code,name:ot.find(M=>M.code===v.code)?.name||v.code,weight:v.pct,parts:w.parts?w.parts[v.code]:null}))}));console.log(`[BLEND-RECIPES]     Best \u0394E: ${C[0].deltaE.toFixed(2)} (${B[0].quality})`),p.push({targetColor:{hex:wt(R.rgb),rgb:R.rgb,lab:R.lab,areaPct:R.areaPct},blends:B})}let b=Date.now()-g,x=Date.now()-a;console.log(`[BLEND-RECIPES] Generated ${p.length} recipe sets in ${b}ms (total: ${x}ms)`);let d=u.palette.map(f=>({hex:wt(f.rgb),rgb:f.rgb,lab:f.lab,areaPct:f.areaPct}));return t.status(200).json({success:!0,colors:d,recipes:p,metadata:{colorsExtracted:u.palette.length,extractionTime:h,solveTime:b,totalTime:x,maxComponents:o}})}catch(e){return console.error("[BLEND-RECIPES] Error:",e),console.error(e.stack),t.status(500).json({success:!1,error:e.message||"Internal server error",stack:process.env.NODE_ENV==="development"?e.stack:void 0})}}function wt(c){let t=e=>Math.round(e).toString(16).padStart(2,"0");return`#${t(c.R)}${t(c.G)}${t(c.B)}`}var je={api:{bodyParser:{sizeLimit:"2mb"},responseLimit:"4mb",externalResolver:!1},maxDuration:60};export{je as config,Ot as default};
