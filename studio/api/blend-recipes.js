var Pt=Object.create;var st=Object.defineProperty;var Gt=Object.getOwnPropertyDescriptor;var vt=Object.getOwnPropertyNames;var Lt=Object.getPrototypeOf,Dt=Object.prototype.hasOwnProperty;var Tt=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var St=(s,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of vt(t))!Dt.call(s,e)&&e!==n&&st(s,e,{get:()=>t[e],enumerable:!(r=Gt(t,e))||r.enumerable});return s};var $t=(s,t,n)=>(n=s!=null?Pt(Lt(s)):{},St(t||!s||!s.__esModule?st(n,"default",{value:s,enumerable:!0}):n,s));var it=Tt((F,k)=>{var F,V;V=(function(){function s(t){var n,r,e,a,o;t==null&&(t={}),this.K=(n=t.K)!=null?n:5,this.maxIterations=(r=t.maxIterations)!=null?r:100,this.enableConvergenceTest=(e=t.enableConvergenceTest)!=null?e:!0,this.tolerance=(a=t.tolerance)!=null?a:1e-9,this.initialize=(o=t.initialize)!=null?o:s.initializeForgy}return s.prototype.cluster=function(t){var n;if(this.X=t,this.prevCentroids=[],this.clusters=[],this.currentIteration=0,n=[this.X.length,this.X[0].length],this.m=n[0],this.n=n[1],this.m==null||this.n==null||this.m<this.K||this.n<1)throw"You must pass more data";return this.centroids=this.initialize(this.X,this.K,this.m,this.n)},s.prototype.step=function(){return this.currentIteration++<this.maxIterations},s.prototype.autoCluster=function(t){var n;for(this.cluster(t),n=[];this.step()&&(this.findClosestCentroids(),this.moveCentroids(),!this.hasConverged());)n.push(void 0);return n},s.initializeForgy=function(t,n,r,e){var a,o,i;for(i=[],a=o=0;0<=n?o<n:o>n;a=0<=n?++o:--o)i.push(t[Math.floor(Math.random()*r)]);return i},s.initializeInRange=function(t,n,r,e){var a,o,i,c,l,u,h,m,p,f,b,R,d,x;for(o=h=0;0<=e?h<e:h>e;o=0<=e?++h:--h)l=1/0;for(o=m=0;0<=e?m<e:m>e;o=0<=e?++m:--m)c=-1/0;for(p=0,b=t.length;p<b;p++)for(u=t[p],o=f=0,R=u.length;f<R;o=++f)a=u[o],l[o]=Math.min(l[o],a),c[o]=Math.max(c[o],a);for(x=[],i=d=0;0<=n?d<n:d>n;i=0<=n?++d:--d)x.push((function(){var g,B;for(B=[],a=g=0;0<=e?g<e:g>e;a=0<=e?++g:--g)B.push(Math.random()*(c[a]-l[a])+l[a]);return B})());return x},s.prototype.findClosestCentroids=function(){var t,n,r,e,a,o,i,c,l,u,h,m,p,f,b,R,d,x;for(this.enableConvergenceTest&&(this.prevCentroids=(function(){var g,B,C,w;for(C=this.centroids,w=[],g=0,B=C.length;g<B;g++)i=C[g],w.push(i.slice(0));return w}).call(this)),this.clusters=(function(){var g,B,C;for(C=[],r=g=0,B=this.K;0<=B?g<B:g>B;r=0<=B?++g:--g)C.push([]);return C}).call(this),b=this.X,x=[],r=u=0,p=b.length;u<p;r=++u){for(c=b[r],n=0,l=1/0,R=this.centroids,e=h=0,f=R.length;h<f;e=++h){for(t=R[e],o=0,a=m=0,d=c.length;0<=d?m<d:m>d;a=0<=d?++m:--m)o+=(c[a]-t[a])*(c[a]-t[a]);o<l&&(n=e,l=o)}x.push(this.clusters[n].push(r))}return x},s.prototype.moveCentroids=function(){var t,n,r,e,a,o,i,c,l;for(c=this.clusters,l=[],r=o=0,i=c.length;o<i;r=++o)t=c[r],!(t.length<1)&&l.push((function(){var u,h,m,p,f;for(f=[],e=u=0,p=this.n;0<=p?u<p:u>p;e=0<=p?++u:--u){for(a=0,h=0,m=t.length;h<m;h++)n=t[h],a+=this.X[n][e];f.push(this.centroids[r][e]=a/t.length)}return f}).call(this));return l},s.prototype.hasConverged=function(){var t,n,r,e,a,o,i;if(!this.enableConvergenceTest)return!1;for(n=e=0,o=this.n;0<=o?e<o:e>o;n=0<=o?++e:--e)for(r=a=0,i=this.m;0<=i?a<i:a>i;r=0<=i?++a:--a)if(t=Math.abs(this.prevCentroids[n][r]-this.centroids[n][r]),this.tolerance>t)return!0;return!1},s})();(typeof k<"u"&&k!==null?k.exports:void 0)!=null||typeof F<"u"&&F!==null?k.exports=F=V:window.kMeans=V});var ut=$t(it(),1);import lt from"sharp";var Z={Xn:.95047,Yn:1,Zn:1.08883},It=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]];function K(s){return s<=.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)}function U(s){return s<=.0031308?s*12.92:1.055*Math.pow(s,1/2.4)-.055}function _(s){return{R:K(s.R/255),G:K(s.G/255),B:K(s.B/255)}}function I(s){return{R:Math.round(U(s.R)*255),G:Math.round(U(s.G)*255),B:Math.round(U(s.B)*255)}}function L(s){let[t,n,r]=It;return{X:t[0]*s.R+t[1]*s.G+t[2]*s.B,Y:n[0]*s.R+n[1]*s.G+n[2]*s.B,Z:r[0]*s.R+r[1]*s.G+r[2]*s.B}}function J(s){let t=.20689655172413793;return s>Math.pow(t,3)?Math.pow(s,1/3):s/(3*t*t)+4/29}function D(s){let t=J(s.X/Z.Xn),n=J(s.Y/Z.Yn),r=J(s.Z/Z.Zn);return{L:116*n-16,a:500*(t-n),b:200*(n-r)}}function ct(s){let t=_(s),n=L(t);return D(n)}var H=class{constructor(t={}){this.options={maxColours:t.maxColours??20,minPercentage:t.minPercentage??.5,resampleSize:t.resampleSize??400,iterations:t.iterations??20}}async extract(t,n){let r=Date.now();try{let e=lt(Buffer.from(t)),a=await e.metadata();if(!a.width||!a.height)throw new Error("Invalid image dimensions");let o=Math.max(a.width,a.height),i=o>this.options.resampleSize?this.options.resampleSize/o:1,c=Math.round(a.width*i),l=Math.round(a.height*i),{data:u,info:h}=await e.resize(c,l,{kernel:lt.kernel.lanczos3,fit:"fill"}).removeAlpha().raw().toBuffer({resolveWithObject:!0}),m=[];for(let d=0;d<u.length;d+=3)m.push({R:u[d],G:u[d+1],B:u[d+2]});let p=this.performKMeans(m,this.options.maxColours),f=m.length,b=p.map((d,x)=>{let g=d.centroid,B={R:Math.round(Math.max(0,Math.min(255,g[0]))),G:Math.round(Math.max(0,Math.min(255,g[1]))),B:Math.round(Math.max(0,Math.min(255,g[2])))},C=d.cluster.length,w=C/f*100;return{rgb:B,pixels:C,percentage:w}}).filter(d=>d.percentage>=this.options.minPercentage).sort((d,x)=>x.percentage-d.percentage),R=Date.now()-r;return console.info(`Final palette: ${b.length} colors, top 5 areas: ${b.slice(0,5).map(d=>d.percentage.toFixed(1)+"%").join(", ")}`),console.info(`Extraction completed in ${R}ms`),{colours:b,metadata:{width:a.width,height:a.height,totalPixels:a.width*a.height,format:n}}}catch(e){throw new Error(`Raster extraction failed: ${e.message}`)}}async extractFromCanvas(t){try{let n=t.getContext("2d");if(!n)throw new Error("Could not get canvas context");let r=n.getImageData(0,0,t.width,t.height),e=[];for(let c=0;c<r.data.length;c+=4)e.push({R:r.data[c],G:r.data[c+1],B:r.data[c+2]});let a=this.performKMeans(e,this.options.maxColours),o=e.length;return{colours:a.map(c=>{let l=c.centroid,u={R:Math.round(Math.max(0,Math.min(255,l[0]))),G:Math.round(Math.max(0,Math.min(255,l[1]))),B:Math.round(Math.max(0,Math.min(255,l[2])))},h=c.cluster.length,m=h/o*100;return{rgb:u,pixels:h,percentage:m}}).filter(c=>c.percentage>=this.options.minPercentage).sort((c,l)=>l.percentage-c.percentage),metadata:{width:t.width,height:t.height,totalPixels:o,format:"canvas"}}}catch(n){throw new Error(`Canvas extraction failed: ${n.message}`)}}performKMeans(t,n){console.info(`K-means input: ${t.length} pixels, requesting ${n} clusters`);let r=[],e=0;for(let l of t)try{let u=_(l),h=L(u),m=D(h);if(isNaN(m.L)||isNaN(m.a)||isNaN(m.b)){e++;continue}r.push(m)}catch{e++;continue}if(e>0&&console.info(`NaN dropped: ${e}`),r.length===0)return console.warn("No valid Lab pixels, using RGB fallback"),this.simpleDominantColors(t,n);let a=Math.min(r.length,5e3),o=r.length>a?this.sampleArray(r,a):r;console.info(`Using ${o.length} sampled pixels`);let i=this.calculateOptimalK(o,n);if(console.info(`Adjusted k from ${n} to ${i}`),i<=1){let l=this.calculateAverageColor(t);return console.info("Single color case, using average:",l),[{centroid:[l.R,l.G,l.B],cluster:t.map(u=>[u.R,u.G,u.B])}]}let c=3;for(let l=0;l<c;l++)try{console.info(`K-means attempt ${l+1}/${c} with k=${i}`);let u=o.map(b=>[b.L,b.a,b.b]),h=new ut.default({K:i});h.cluster(u);let m=0,p=this.options.iterations||20;for(;h.step()&&m<p;){if(h.findClosestCentroids(),h.moveCentroids(),h.hasConverged()){console.info(`K-means converged in ${m} iterations`);break}m++}if(!h.centroids||h.centroids.length===0)throw new Error(`K-means returned empty result on attempt ${l+1}`);console.info(`K-means attempt ${l+1}: success with ${h.centroids.length} clusters in ${m} iterations`);let f=h.centroids.map((b,R)=>({centroid:b,cluster:h.clusters[R]||[]}));return this.convertLabClustersToRGB(f,t,r)}catch(u){if(console.warn(`K-means attempt ${l+1} failed:`,u.message),l===c-1)return console.warn("All k-means attempts failed, using fallback method"),this.simpleDominantColors(t,i)}return this.simpleDominantColors(t,i)}calculateOptimalK(t,n){let r=new Set;for(let a of t){let o=Math.round(a.L/4)*4,i=Math.round(a.a/2)*2,c=Math.round(a.b/2)*2;r.add(`${o},${i},${c}`)}let e=r.size;if(e<64)return Math.min(e,10,n);{let a=Math.round(Math.sqrt(e/2));return Math.max(6,Math.min(a,18,n))}}convertLabClustersToRGB(t,n,r){let e=[];for(let a of t){let[o,i,c]=a.centroid;try{let l={X:95.047*Math.pow((o+16)/116+i/500,3)/100,Y:100*Math.pow((o+16)/116,3)/100,Z:108.883*Math.pow((o+16)/116-c/200,3)/100},u=l.X*3.2406+l.Y*-1.5372+l.Z*-.4986,h=l.X*-.9689+l.Y*1.8758+l.Z*.0415,m=l.X*.0557+l.Y*-.204+l.Z*1.057,p=R=>(R=Math.max(0,Math.min(1,R)),R<=.0031308?12.92*R:1.055*Math.pow(R,1/2.4)-.055),f={R:Math.round(p(u)*255),G:Math.round(p(h)*255),B:Math.round(p(m)*255)},b=[];for(let R=0;R<r.length;R++){let d=r[R],x=Math.sqrt(Math.pow(d.L-o,2)+Math.pow(d.a-i,2)+Math.pow(d.b-c,2)),g=1/0,B=0;for(let C=0;C<n.length;C++){let w=Math.sqrt(Math.pow(n[C].R-f.R,2)+Math.pow(n[C].G-f.G,2)+Math.pow(n[C].B-f.B,2));w<g&&(g=w,B=C)}b.push([n[B].R,n[B].G,n[B].B])}e.push({centroid:[f.R,f.G,f.B],cluster:b.length>0?b:[[f.R,f.G,f.B]]})}catch(l){console.warn("Failed to convert Lab cluster to RGB:",l);let u=this.calculateAverageColor(n);e.push({centroid:[u.R,u.G,u.B],cluster:n.map(h=>[h.R,h.G,h.B])})}}return e}sampleArray(t,n){if(t.length<=n)return t;let r=t.length/n,e=[];for(let a=0;a<t.length;a+=r)e.push(t[Math.floor(a)]);return e.slice(0,n)}findClosestCluster(t,n){let r=1/0,e=n[0];for(let a of n){let o=Math.sqrt(Math.pow(t[0][0]-a[0],2)+Math.pow(t[0][1]-a[1],2)+Math.pow(t[0][2]-a[2],2));o<r&&(r=o,e=a)}return e}simpleDominantColors(t,n){console.info("Using simple color quantization fallback");let r=new Map,e=t.length;for(let i of t){let c={R:Math.floor(i.R/6)*6,G:Math.floor(i.G/6)*6,B:Math.floor(i.B/6)*6},l=`${c.R},${c.G},${c.B}`,u=r.get(l);if(u)u.count++;else{let h;try{let m=_(c),p=L(m);h=D(p)}catch{}r.set(l,{count:1,rgb:c,lab:h})}}let a=Array.from(r.entries()).filter(([i,c])=>c.lab!==void 0).map(([i,c])=>({key:i,rgb:c.rgb,lab:c.lab,count:c.count,percentage:c.count/e*100}));console.info(`Pre-merge: ${a.length} quantized colors`),a=this.mergeNearbyColors(a).filter(i=>i.lab!==void 0);let o=a.sort((i,c)=>c.count-i.count).slice(0,n);return console.info(`Post-merge: ${o.length} final colors`),o.map(i=>({centroid:[i.rgb.R,i.rgb.G,i.rgb.B],cluster:t.filter(c=>{let l={R:Math.floor(c.R/6)*6,G:Math.floor(c.G/6)*6,B:Math.floor(c.B/6)*6};return`${l.R},${l.G},${l.B}`===i.key}).map(c=>[c.R,c.G,c.B])}))}mergeNearbyColors(t){t.sort((o,i)=>i.percentage-o.percentage);let a=[];for(let o of t){let i=!1;if(o.percentage>=.75){a.push(o);continue}for(let c of a){if(!o.lab||!c.lab)continue;let l=Math.sqrt(Math.pow(o.lab.L-c.lab.L,2)+Math.pow(o.lab.a-c.lab.a,2)+Math.pow(o.lab.b-c.lab.b,2)),u=Math.abs(o.lab.a-c.lab.a),h=Math.abs(o.lab.b-c.lab.b);if(l<=1.5&&u<=8&&h<=8){let m=c.percentage+o.percentage,p=c.count+o.count;c.rgb={R:Math.round((c.rgb.R*c.count+o.rgb.R*o.count)/p),G:Math.round((c.rgb.G*c.count+o.rgb.G*o.count)/p),B:Math.round((c.rgb.B*c.count+o.rgb.B*o.count)/p)},c.lab={L:(c.lab.L*c.percentage+o.lab.L*o.percentage)/m,a:(c.lab.a*c.percentage+o.lab.a*o.percentage)/m,b:(c.lab.b*c.percentage+o.lab.b*o.percentage)/m},c.count=p,c.percentage=m,i=!0;break}}i||a.push(o)}return a}calculateAverageColor(t){if(t.length===0)return{R:0,G:0,B:0};let n=t.reduce((r,e)=>({R:r.R+e.R,G:r.G+e.G,B:r.B+e.B}),{R:0,G:0,B:0});return{R:Math.round(n.R/t.length),G:Math.round(n.G/t.length),B:Math.round(n.B/t.length)}}};var A=class{constructor(t={}){this.options={whitePoint:t.whitePoint??"D65",gamma:t.gamma??2.4}}rgbToLab(t){return ct(t)}rgbToHex(t){let n=r=>Math.round(Math.max(0,Math.min(255,r))).toString(16).padStart(2,"0");return`#${n(t.R)}${n(t.G)}${n(t.B)}`}hexToRgb(t){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw new Error(`Invalid hex color: ${t}`);return{R:parseInt(n[1],16),G:parseInt(n[2],16),B:parseInt(n[3],16)}}calculateDeltaE(t,n){let r=t.L-n.L,e=t.a-n.a,a=t.b-n.b;return Math.sqrt(r*r+e*e+a*a)}deduplicate(t,n=5){let r=[];for(let e of t)if(!r.some(o=>this.calculateDeltaE(o.lab,e.lab)<n))r.push(e);else{let o=r.find(i=>this.calculateDeltaE(i.lab,e.lab)<n);o&&(o.areaPct+=e.areaPct,o.pageIds&&e.pageIds&&(o.pageIds=[...new Set([...o.pageIds,...e.pageIds])]))}return r}normalizeAreas(t){let n=t.reduce((r,e)=>r+e.areaPct,0);return n===0?t:t.map(r=>({...r,areaPct:r.areaPct/n*100}))}filterInsignificant(t,n=1,r=!0,e=!0){return t.filter(a=>!(a.areaPct<n||r&&a.lab.L>95||e&&a.lab.L<5))}sortByImportance(t){return t.sort((n,r)=>{if(Math.abs(n.areaPct-r.areaPct)>1)return r.areaPct-n.areaPct;let e=Math.sqrt(n.lab.a*n.lab.a+n.lab.b*n.lab.b);return Math.sqrt(r.lab.a*r.lab.a+r.lab.b*r.lab.b)-e})}};function Q(s,t){let n=new A().rgbToHex(s),r=Array.from(n).reduce((e,a)=>(e=(e<<5)-e+a.charCodeAt(0),e&e),0);return`${t}_${Math.abs(r).toString(36)}`}function ht(s,t,n="merge"){let r=new A;switch(n){case"prefer-pdf":return s.length>0?s:t;case"prefer-raster":return t.length>0?t:s;case"merge":default:let e=[...s,...t],a=r.deduplicate(e,8),o=r.normalizeAreas(a);return r.sortByImportance(o)}}function mt(s){let t=s.toLowerCase().split(".").pop();if(!t)return{isValid:!1,type:null};let n=["png","jpg","jpeg","svg","webp"];return["pdf"].includes(t)?{isValid:!0,type:"pdf",format:t}:n.includes(t)?{isValid:!0,type:"image",format:t}:{isValid:!1,type:null}}function pt(s,t){return t==="pdf"?s<2*1048576?"low":s<10*1048576?"medium":"high":s<1*1048576?"low":s<5*1048576?"medium":"high"}var et=class{constructor(t={}){this.cache=new Map;this.options={defaultTTL:t.defaultTTL??1800*1e3,maxEntries:t.maxEntries??100,cleanupInterval:t.cleanupInterval??300*1e3},this.startCleanup()}set(t,n,r){let e={data:n,timestamp:Date.now(),ttl:r??this.options.defaultTTL,hits:0};this.cache.set(t,e),this.evictOldest()}get(t){let n=this.cache.get(t);return n?Date.now()-n.timestamp>n.ttl?(this.cache.delete(t),null):(n.hits++,n.data):null}has(t){let n=this.cache.get(t);return n?Date.now()-n.timestamp>n.ttl?(this.cache.delete(t),!1):!0:!1}delete(t){return this.cache.delete(t)}clear(){this.cache.clear()}size(){return this.cache.size}getStats(){let t=Array.from(this.cache.values()),n=Date.now(),r=t.reduce((i,c)=>i+c.hits,0),e=t.reduce((i,c)=>i+(n-c.timestamp),0),a=t.length>0?e/t.length:0,o=t.length>0?r/t.length:0;return{entries:t.length,totalHits:r,averageAge:a,hitRate:o}}evictOldest(){if(this.cache.size<=this.options.maxEntries)return;let t="",n=Date.now();for(let[r,e]of this.cache)e.timestamp<n&&(n=e.timestamp,t=r);t&&this.cache.delete(t)}startCleanup(){this.cleanupTimer=setInterval(()=>{this.cleanup()},this.options.cleanupInterval)}cleanup(){let t=Date.now(),n=[];for(let[r,e]of this.cache)t-e.timestamp>e.ttl&&n.push(r);for(let r of n)this.cache.delete(r)}destroy(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.clear()}},tt=null;function dt(){return tt||(tt=new et({defaultTTL:3600*1e3,maxEntries:50,cleanupInterval:600*1e3})),tt}function ft(s,t,n={}){let r=JSON.stringify(n),e=`${s}-${t}-${r}`,a=0;for(let o=0;o<e.length;o++){let i=e.charCodeAt(o);a=(a<<5)-a+i,a=a&a}return Math.abs(a).toString(36)}var N=class{constructor(t={}){this.options={maxColours:t.maxColours??15,minAreaPct:t.minAreaPct??1,combineStrategy:t.combineStrategy??"merge",rasterFallback:t.rasterFallback??!0,pdfOptions:{minFrequency:3,tolerance:8,...t.pdfOptions},rasterOptions:{resampleSize:400,iterations:15,...t.rasterOptions}},this.converter=new A,this.rasterExtractor=new H({maxColours:this.options.maxColours,minPercentage:this.options.minAreaPct,...this.options.rasterOptions})}async extract(t,n,r){let e=Date.now(),a=mt(n),o=pt(t.byteLength,a.type),i=[],c=[];if(!a.isValid)throw new Error(`Unsupported file type: ${n}`);let l=dt(),u=ft(n,t.byteLength,this.options),h=l.get(u);if(h)return r?.updateProgress("complete",100,"Using cached result"),h;r?.updateProgress("extracting",10,"Starting color extraction...");try{let m=[],p=[];if(a.type==="pdf"&&(r?.updateProgress("extracting",25,"Skipping server PDF processing - client handles extraction..."),i.push("PDF processing handled client-side. Server extraction skipped to avoid canvas dependencies."),console.info("Skipping server-side PDF processing - relying on client-side extraction")),a.type==="image")try{r?.updateProgress("extracting",40,"Analyzing raster image colors..."),p=(await this.rasterExtractor.extract(t,a.format)).colours.map(d=>({id:Q(d.rgb,"raster"),rgb:d.rgb,lab:this.converter.rgbToLab(d.rgb),areaPct:d.percentage,source:"raster",metadata:{pixels:d.pixels,percentage:d.percentage}})),c.push("raster"),p.length===0&&i.push("No significant colors found in raster image")}catch(R){throw new Error(`Image extraction failed: ${R.message}`)}r?.updateProgress("processing",70,"Combining and filtering colors...");let f=ht(m,p,this.options.combineStrategy);f=this.converter.filterInsignificant(f,this.options.minAreaPct),f=this.converter.sortByImportance(f),f.length>this.options.maxColours&&(f=f.slice(0,this.options.maxColours),i.push(`Truncated to ${this.options.maxColours} most significant colors`)),f.length===0&&(i.push("No colors extracted, using fallback"),f=[{id:Q({R:128,G:128,B:128},"fallback"),rgb:{R:128,G:128,B:128},lab:this.converter.rgbToLab({R:128,G:128,B:128}),areaPct:100,source:"raster"}]);let b={palette:f,metadata:{filename:n,fileSize:t.byteLength,fileType:a.type,extractionTime:Date.now()-e,complexity:o,sources:c,totalColours:{pdf:m.length||void 0,raster:p.length||void 0,combined:f.length}},warnings:i.length>0?i:void 0};return r?.updateProgress("caching",90,"Caching extraction result..."),l.set(u,b,3600*1e3),r?.complete(),b}catch(m){throw new Error(`Palette extraction failed: ${m.message}`)}}};function G(s,t){let{L:n,a:r,b:e}=s,{L:a,a:o,b:i}=t,c=1,l=1,u=1,h=Math.sqrt(r*r+e*e),m=Math.sqrt(o*o+i*i),p=(h+m)/2,f=.5*(1-Math.sqrt(Math.pow(p,7)/(Math.pow(p,7)+Math.pow(25,7)))),b=(1+f)*r,R=(1+f)*o,d=Math.sqrt(b*b+e*e),x=Math.sqrt(R*R+i*i),g=Math.atan2(e,b)*180/Math.PI;g<0&&(g+=360);let B=Math.atan2(i,R)*180/Math.PI;B<0&&(B+=360);let C=a-n,w=x-d,v;if(d*x===0)v=0;else{let $=B-g;Math.abs($)<=180?v=$:$>180?v=$-360:v=$+360}let M=2*Math.sqrt(d*x)*Math.sin(v*Math.PI/360),E=(n+a)/2,P=(d+x)/2,y;if(d*x===0)y=g+B;else{let $=Math.abs(g-B),q=g+B;$<=180?y=q/2:q<360?y=(q+360)/2:y=(q-360)/2}let T=1-.17*Math.cos((y-30)*Math.PI/180)+.24*Math.cos(2*y*Math.PI/180)+.32*Math.cos((3*y+6)*Math.PI/180)-.2*Math.cos((4*y-63)*Math.PI/180),X=30*Math.exp(-Math.pow((y-275)/25,2)),Mt=2*Math.sqrt(Math.pow(P,7)/(Math.pow(P,7)+Math.pow(25,7))),Et=1+.015*Math.pow(E-50,2)/Math.sqrt(20+Math.pow(E-50,2)),ot=1+.045*P,at=1+.015*P*T,yt=-Math.sin(2*X*Math.PI/180)*Mt;return Math.sqrt(Math.pow(C/(c*Et),2)+Math.pow(w/(l*ot),2)+Math.pow(M/(u*at),2)+yt*(w/(l*ot))*(M/(u*at)))}function gt(s){return s.map(t=>({...t,linearRGB:_({R:t.R,G:t.G,B:t.B})}))}function S(s){let t=0,n=0,r=0,e=0;for(let{color:a,weight:o}of s)t+=a.R*o,n+=a.G*o,r+=a.B*o,e+=o;return e===0?{R:0,G:0,B:0}:{R:t/e,G:n/e,B:r/e}}function z(s){let t=s.reduce((n,r)=>n+r,0);return t===0?s:s.map(n=>n/t)}function bt(s,t){return t===0?Math.abs(s):bt(t,s%t)}function W(s){return s.length===0?1:s.length===1?Math.abs(s[0]):s.reduce((t,n)=>bt(t,n),0)||1}function nt(s){return s.reduce((t,n,r,e)=>n>e[t]?r:t,0)}function _t(s,t){let n=W(s),r=s.map(l=>Math.max(1,Math.round(l/n))),e=t.map((l,u)=>({c:l,w:r[u]})).sort((l,u)=>l.c.localeCompare(u.c)),a=e.map(l=>l.c),o=e.map(l=>l.w),i=o.reduce((l,u)=>l+u,0),c=`parts:${a.map((l,u)=>`${l}:${o[u]}`).join("|")}`;return{codes:a,parts:o,total:i,key:c}}function At(s){let n=s.map(({code:l,pct:u})=>({c:l,n:Math.round(u*2400)})).filter(l=>l.n>0),r=W(n.map(l=>l.n)),e=n.map(l=>({c:l.c,n:Math.max(1,Math.round(l.n/r))}));e.sort((l,u)=>l.c.localeCompare(u.c));let a=`pct:${e.map(l=>`${l.c}:${l.n}`).join("|")}`,o=e.reduce((l,u)=>l+u.n,0),i=e.map(l=>l.n/o);return{codes:e.map(l=>l.c),weights:i,key:a}}function jt(s){let t=(n,r)=>Math.round(n/r);return`lab:${t(s.L,.75)}:${t(s.a,1)}:${t(s.b,1)}`}function kt(s,t){let n=s.mode==="parts"&&s.parts?s.parts.codes.length:s.components.length,r=t.mode==="parts"&&t.parts?t.parts.codes.length:t.components.length;if(n!==r)return n<r;let e=s.mode==="parts"&&s.parts?s.parts.total:1/0,a=t.mode==="parts"&&t.parts?t.parts.total:1/0;return e!==a?e<a:s.deltaE<t.deltaE}function O(s){let t=s.mode==="parts"&&s.parts?s.parts.codes.length:s.components.length,n=s.mode==="parts"&&s.parts?s.parts.total:9999;return t*1e3+n+s.deltaE}function Rt(s){let t=new Map;for(let e of s){let a=e.mode==="parts"&&e.parts?_t(e.parts.parts,e.parts.codes).key:At(e.components).key,o=t.get(a);(!o||kt(e,o))&&t.set(a,e)}let n=new Map;for(let e of Array.from(t.values())){let a=jt(e.lab),o=n.get(a)||[];o.push(e),n.set(a,o)}let r=[];for(let e of Array.from(n.values()))e.sort((a,o)=>O(a)-O(o)),r.push(e[0]);return r.sort((e,a)=>O(e)-O(a))}function xt(s,t,n=.75){let r=[],e=[...s],a=(o,i)=>Math.hypot(o.lab.L-i.lab.L,o.lab.a-i.lab.a,o.lab.b-i.lab.b);for(;r.length<t&&e.length>0;){let o=0,i=1/0;for(let c=0;c<e.length;c++){let l=e[c],u=l.deltaE,h=r.length>0?Math.min(...r.map(p=>a(l,p))):1e3,m=n*u-(1-n)*h;m<i&&(i=m,o=c)}r.push(e.splice(o,1)[0])}return r}function Ft(s,t,n,r={separation:45,closeness:12,penalty:2}){let e=G(s,t),a=G(s,n),o=G(t,n);return e>r.separation&&Math.min(a,o)>r.closeness?r.penalty:0}function zt(s,t={dominant:.7,adjuster:.25,dominantBonus:-.3,adjusterBonus:-.2}){let n=[...s].sort((e,a)=>a-e),r=0;return n[0]>=t.dominant&&(r+=t.dominantBonus),n.length>1&&n[1]<=t.adjuster&&(r+=t.adjusterBonus),r}function Xt(s,t,n,r,e={topN:6,minWeight:.6,bonus:-.5}){let a=G(s,t),o=[...r].sort((c,l)=>c-l);return a<=o[e.topN-1]&&n>=e.minWeight?e.bonus:0}function j(s,t,n){let r=0;if(s.length>=2)for(let a=0;a<s.length;a++)for(let o=a+1;o<s.length;o++){let i=Ft(s[a].lab,s[o].lab,t);r+=s.length===3?i*.5:i}let e=s.map(a=>a.weight);if(r+=zt(e),s.length>0){let a=s.reduce((o,i)=>i.weight>o.weight?i:o);r+=Xt(a.lab,t,a.weight,n)}return r}function qt(s,t,n,r){let{total:e,minPer:a,maxAttempts:o=3}=r,i=Object.keys(s).filter(M=>s[M]>0);if(i.length===0)return null;let c=i.map(M=>Math.max(a,Math.round(s[M]*e))),l=c.reduce((M,E)=>M+E,0),u=0;for(;l!==e&&u<o*10;){if(e-l>0){let E=c.map((y,T)=>s[i[T]]*e-y),P=nt(E);c[P]++}else{let E=c.map((y,T)=>y-s[i[T]]*e),P=nt(E);c[P]>a&&c[P]--}l=c.reduce((E,P)=>E+P,0),u++}if(l!==e)return null;let h=[...c],m=Bt(i,c,t,n);for(let M=0;M<5;M++){let E=!1;for(let P=0;P<i.length;P++)for(let y=0;y<i.length;y++){if(P===y||c[P]<=a)continue;let T=[...c];T[P]--,T[y]++;let X=Bt(i,T,t,n);X<m&&(h=[...T],m=X,E=!0)}if(!E)break;c=[...h]}let p=W(h),f=h.map(M=>M/p),b=f.reduce((M,E)=>M+E,0),R=z(f),d={},x={};i.forEach((M,E)=>{d[M]=f[E],x[M]=R[E]});let g=i.map((M,E)=>({color:t.find(y=>y.code===M).linearRGB,weight:R[E]})),B=S(g),C=I(B),w=L(B),v=D(w);return{parts:d,weights:x,total:b,deltaE:G(n,v),lab:v,rgb:C}}function Bt(s,t,n,r){let e=z(t),a=s.map((l,u)=>({color:n.find(m=>m.code===l).linearRGB,weight:e[u]})),o=S(a),i=L(o),c=D(i);return G(r,c)}function Ct(s,t,n,r={totals:[9,12,15,18],minPer:1,maxDeltaEPenalty:.8}){let e=null;for(let a of r.totals){let o=qt(s,t,n,{total:a,minPer:r.minPer});if(o&&((!e||o.deltaE<r.maxDeltaEPenalty||o.deltaE<e.deltaE)&&(e=o),o.deltaE<r.maxDeltaEPenalty))break}return e}var Y=class{constructor(t,n){this.colours=t;this.constraints=n;this.twoWayCache=[];this.singleDistances=[];this.enhancedColours=gt(t),this.precomputeTwoWayBlends()}getHueSector(t){let r=(Math.atan2(t.b,t.a)*180/Math.PI%360+360)%360;return Math.floor(r/60)}toDedupeRecipe(t){return{components:t.components,mode:this.constraints.mode,parts:t.parts&&t.total?{codes:Object.keys(t.parts),parts:Object.values(t.parts),total:t.total}:void 0,lab:t.lab,deltaE:t.deltaE,weights:t.weights}}fromDedupeRecipe(t){let n=t.parts?t.parts.codes.reduce((e,a,o)=>(e[a]=t.parts.parts[o],e),{}):void 0,r=this.calculateRGBFromWeights(t.weights);return{components:t.components,weights:t.weights,parts:n,total:t.parts?.total,lab:t.lab,rgb:r,deltaE:t.deltaE,baseDeltaE:t.deltaE,note:t.mode==="parts"?"Parts blend":"Percentage blend",reasoning:"Generated by enhanced solver"}}calculateRGBFromWeights(t){let n=Object.entries(t).map(([e,a])=>{let o=this.enhancedColours.find(i=>i.code===e);return o?{color:o.linearRGB,weight:a}:{color:{R:.5,G:.5,B:.5},weight:a}});if(n.length===0)return{R:128,G:128,B:128};let r=S(n);return I(r)}solve(t,n=5){let r=[];if(this.singleDistances=this.enhancedColours.map(l=>G(t,{L:l.L,a:l.a,b:l.b})),this.constraints.maxComponents>=1){let l=this.solveSingleComponents(t);r.push(...l)}if(this.constraints.maxComponents>=2){let l=this.solveTwoWayBlends(t);r.push(...l)}if(this.constraints.maxComponents>=3){let l=this.solveThreeWayBlendsWithHueDiversity(t);r.push(...l)}if(r.length<n*3&&this.constraints.maxComponents<3){let l=this.autoExpandSearch(t,n*2);r.push(...l)}let a=r.map(l=>this.convertToPartsIfNeeded(l,t)).map(l=>this.toDedupeRecipe(l)),o=Rt(a);return xt(o,n*2,.75).slice(0,n).map(l=>this.fromDedupeRecipe(l))}autoExpandSearch(t,n){let r=[];if(this.constraints.maxComponents<3){let e=this.constraints.maxComponents;this.constraints.maxComponents=3;let a=this.solveThreeWayBlendsWithHueDiversity(t);r.push(...a.slice(0,Math.ceil(n/2))),this.constraints.maxComponents=e}if(r.length<n){let e=this.constraints.minPct,a=Math.max(.05,this.constraints.minPct-.03);this.constraints.minPct=a;for(let o of this.twoWayCache.slice(0,n*2))if(o.p>=a&&1-o.p>=a){o.deltaE=G(t,o.lab);let i=this.enhancedColours[o.i],c=this.enhancedColours[o.j],l=j([{lab:{L:i.L,a:i.a,b:i.b},weight:o.p},{lab:{L:c.L,a:c.a,b:c.b},weight:1-o.p}],t,this.singleDistances);o.adjustedDeltaE=o.deltaE+l;let u=o.p>=.6?i:o.p<=.4?c:null,h=u?`Relaxed ${u.name} with ${u===i?c.name:i.name} adjustment`:`Relaxed balanced mix of ${i.name} and ${c.name}`;if(r.push({components:[{code:i.code,pct:o.p},{code:c.code,pct:1-o.p}],weights:{[i.code]:o.p,[c.code]:1-o.p},lab:o.lab,rgb:I(S([{color:i.linearRGB,weight:o.p},{color:c.linearRGB,weight:1-o.p}])),deltaE:o.adjustedDeltaE,baseDeltaE:o.deltaE,note:"2-component expanded blend",reasoning:h}),r.length>=n)break}this.constraints.minPct=e}return r.slice(0,n)}precomputeTwoWayBlends(){let{minPct:t}=this.constraints,n=1-t,r=Math.max(.04,this.constraints.stepPct*2);for(let e=0;e<this.enhancedColours.length;e++)for(let a=e+1;a<this.enhancedColours.length;a++){let o=this.enhancedColours[e],i=this.enhancedColours[a];for(let c=t;c<=n;c+=r){let l=S([{color:o.linearRGB,weight:c},{color:i.linearRGB,weight:1-c}]),u=L(l),h=D(u);this.twoWayCache.push({i:e,j:a,p:c,lab:h,deltaE:0,adjustedDeltaE:0})}}}refineTopCandidates(t,n,r=20){let e=[],a=Math.min(.01,this.constraints.stepPct);for(let o of t.slice(0,r)){let i=this.enhancedColours[o.i],c=this.enhancedColours[o.j],l=.08,u=Math.max(this.constraints.minPct,o.p-l),h=Math.min(1-this.constraints.minPct,o.p+l),m=o;for(let p=u;p<=h;p+=a){let f=S([{color:i.linearRGB,weight:p},{color:c.linearRGB,weight:1-p}]),b=L(f),R=D(b),d=G(n,R),x=j([{lab:{L:i.L,a:i.a,b:i.b},weight:p},{lab:{L:c.L,a:c.a,b:c.b},weight:1-p}],n,this.singleDistances),g=d+x;g<m.adjustedDeltaE&&(m={i:o.i,j:o.j,p,lab:R,deltaE:d,adjustedDeltaE:g})}e.push(m)}return e.sort((o,i)=>o.adjustedDeltaE-i.adjustedDeltaE)}solveSingleComponents(t){let n=[];for(let r=0;r<this.enhancedColours.length;r++){let e=this.enhancedColours[r],a={L:e.L,a:e.a,b:e.b},o=G(t,a);n.push({components:[{code:e.code,pct:1}],weights:{[e.code]:1},lab:a,rgb:{R:e.R,G:e.G,B:e.B},deltaE:o,baseDeltaE:o,note:"Single component",reasoning:`Direct match with ${e.name}`})}return n.sort((r,e)=>r.deltaE-e.deltaE).slice(0,2)}solveTwoWayBlends(t){for(let e of this.twoWayCache){e.deltaE=G(t,e.lab);let a=this.enhancedColours[e.i],o=this.enhancedColours[e.j],i=j([{lab:{L:a.L,a:a.a,b:a.b},weight:e.p},{lab:{L:o.L,a:o.a,b:o.b},weight:1-e.p}],t,this.singleDistances);e.adjustedDeltaE=e.deltaE+i}let n=this.twoWayCache.slice().sort((e,a)=>e.adjustedDeltaE-a.adjustedDeltaE).slice(0,30);return this.refineTopCandidates(n,t,15).slice(0,10).map(e=>{let a=this.enhancedColours[e.i],o=this.enhancedColours[e.j],i=e.p>=.6?a:e.p<=.4?o:null,c=i?`Anchor ${i.name} with ${i===a?o.name:a.name} adjustment`:`Balanced mix of ${a.name} and ${o.name}`;return{components:[{code:a.code,pct:e.p},{code:o.code,pct:1-e.p}],weights:{[a.code]:e.p,[o.code]:1-e.p},lab:e.lab,rgb:I(S([{color:a.linearRGB,weight:e.p},{color:o.linearRGB,weight:1-e.p}])),deltaE:e.adjustedDeltaE,baseDeltaE:e.deltaE,note:"2-component blend",reasoning:c}})}solveThreeWayBlendsWithHueDiversity(t){let n=[],r=new Map;for(let a of this.twoWayCache){a.deltaE=G(t,a.lab);let o=this.enhancedColours[a.i],i=this.enhancedColours[a.j],c=j([{lab:{L:o.L,a:o.a,b:o.b},weight:a.p},{lab:{L:i.L,a:i.a,b:i.b},weight:1-a.p}],t,this.singleDistances);a.adjustedDeltaE=a.deltaE+c;let l=this.getHueSector(a.lab),u=r.get(l)||[];u.push(a),r.set(l,u)}let e=[];for(let a of Array.from(r.values()))a.sort((o,i)=>o.adjustedDeltaE-i.adjustedDeltaE),e.push(...a.slice(0,4));if(e.length<24){let a=Array.from(r.values()).flat();a.sort((i,c)=>i.adjustedDeltaE-c.adjustedDeltaE);let o=30-e.length;e.push(...a.slice(0,o))}return this.generateThreeWayFromSeeds(e,t)}generateThreeWayFromSeeds(t,n){let r=[];for(let e of t){let a=[e.i,e.j];for(let o=0;o<this.enhancedColours.length;o++){if(a.includes(o))continue;let i=this.enhancedColours[o];for(let c=this.constraints.minPct;c<=1-2*this.constraints.minPct;c+=this.constraints.stepPct*2){let l=1-c,u=Math.max(this.constraints.minPct,e.p*l),h=l-u;if(h<this.constraints.minPct)continue;let m=z([u,h,c]),[p,f,b]=m,R=S([{color:this.enhancedColours[e.i].linearRGB,weight:p},{color:this.enhancedColours[e.j].linearRGB,weight:f},{color:i.linearRGB,weight:b}]),d=L(R),x=D(d),g=G(n,x),B=j([{lab:{L:this.enhancedColours[e.i].L,a:this.enhancedColours[e.i].a,b:this.enhancedColours[e.i].b},weight:p},{lab:{L:this.enhancedColours[e.j].L,a:this.enhancedColours[e.j].a,b:this.enhancedColours[e.j].b},weight:f},{lab:{L:i.L,a:i.a,b:i.b},weight:b}],n,this.singleDistances),C=g+B;r.push({components:[{code:this.enhancedColours[e.i].code,pct:p},{code:this.enhancedColours[e.j].code,pct:f},{code:i.code,pct:b}],weights:{[this.enhancedColours[e.i].code]:p,[this.enhancedColours[e.j].code]:f,[i.code]:b},lab:x,rgb:I(R),deltaE:C,baseDeltaE:g,note:"3-component blend",reasoning:"Refined blend with three components"})}}}return r.sort((e,a)=>e.deltaE-a.deltaE).slice(0,5)}convertToPartsIfNeeded(t,n){if(this.constraints.mode!=="parts"||!this.constraints.parts?.enabled)return t;let r=Ct(t.weights,this.enhancedColours,n,{totals:this.constraints.parts.total?[this.constraints.parts.total]:[9,12,15],minPer:this.constraints.parts.minPer||1,maxDeltaEPenalty:.8});return r?{...t,parts:r.parts,total:r.total,weights:r.weights,lab:r.lab,rgb:r.rgb,deltaE:r.deltaE,note:t.note+` (${r.total} parts total)`,reasoning:t.reasoning+` - Snapped to ${r.total} parts with \u0394E ${(r.deltaE-t.baseDeltaE).toFixed(2)} penalty`}:t}};var rt=[{code:"RH01",name:"Standard Red",hex:"#B71E2D",R:183,G:30,B:45,L:39.4,a:58.5,b:29},{code:"RH02",name:"Bright Red",hex:"#E31D25",R:227,G:29,B:37,L:47.4,a:70.1,b:44},{code:"RH10",name:"Standard Green",hex:"#006B3F",R:0,G:107,B:63,L:40.5,a:-42.2,b:17.9},{code:"RH11",name:"Bright Green",hex:"#4BAA34",R:75,G:170,B:52,L:62.1,a:-47.7,b:47.2},{code:"RH12",name:"Dark Green",hex:"#006747",R:0,G:103,B:71,L:39.6,a:-38.3,b:13.1},{code:"RH20",name:"Standard Blue",hex:"#1B4F9C",R:27,G:79,B:156,L:36.4,a:14.2,b:-46.7},{code:"RH21",name:"Purple",hex:"#662D91",R:102,G:45,B:145,L:31.5,a:41.9,b:-40.9},{code:"RH22",name:"Light Blue",hex:"#0091D7",R:0,G:145,B:215,L:55.3,a:-19.1,b:-37.3},{code:"RH23",name:"Azure",hex:"#0076B6",R:0,G:118,B:182,L:47.7,a:-4.8,b:-34.8},{code:"RH26",name:"Turquoise",hex:"#00A499",R:0,G:164,B:153,L:58.8,a:-38.4,b:-3},{code:"RH30",name:"Standard Beige",hex:"#D4B585",R:212,G:181,B:133,L:75.2,a:3.8,b:24.8},{code:"RH31",name:"Cream",hex:"#F2E6C8",R:242,G:230,B:200,L:91.8,a:-.5,b:12.5},{code:"RH32",name:"Brown",hex:"#754C29",R:117,G:76,B:41,L:40,a:15.9,b:27.1},{code:"RH90",name:"Funky Pink",hex:"#e8457e",R:232,G:69,B:126,L:55,a:66.1,b:4.9},{code:"RH40",name:"Mustard Yellow",hex:"#C6972D",R:198,G:151,B:45,L:66,a:8.4,b:56.3},{code:"RH41",name:"Bright Yellow",hex:"#FFD100",R:255,G:209,B:0,L:86.9,a:-1,b:90.6},{code:"RH50",name:"Orange",hex:"#F47920",R:244,G:121,B:32,L:63.2,a:49.8,b:60.2},{code:"RH60",name:"Dark Grey",hex:"#4D4F53",R:77,G:79,B:83,L:34.1,a:-.4,b:-2.4},{code:"RH61",name:"Light Grey",hex:"#A7A8AA",R:167,G:168,B:170,L:69,a:-.5,b:-1},{code:"RH65",name:"Pale Grey",hex:"#DCDDDE",R:220,G:221,B:222,L:87.6,a:-.2,b:-.7},{code:"RH70",name:"Black",hex:"#101820",R:16,G:24,B:32,L:9.1,a:-.3,b:-6.3}];async function Nt(s,t){if(s.method!=="POST")return t.status(405).json({success:!1,error:"Method not allowed. Use POST."});try{let{svg_url:n,job_id:r,max_colors:e=8,max_components:a=2}=s.body;if(!n)return t.status(400).json({success:!1,error:"Missing required field: svg_url"});console.log("[BLEND-RECIPES] Starting color extraction for job:",r),console.log("[BLEND-RECIPES] SVG URL:",n),console.log("[BLEND-RECIPES] Max colors:",e,"Max components:",a);let o=Date.now();console.log("[BLEND-RECIPES] Fetching SVG from URL...");let i=await fetch(n);if(!i.ok)throw new Error(`Failed to fetch SVG: ${i.status} ${i.statusText}`);let c=await i.arrayBuffer();console.log(`[BLEND-RECIPES] SVG fetched (${c.byteLength} bytes)`),console.log("[BLEND-RECIPES] Extracting colors...");let u=await new N({maxColours:e,minAreaPct:1,rasterOptions:{resampleSize:400,iterations:15}}).extract(c,"design.svg"),h=Date.now()-o;if(console.log(`[BLEND-RECIPES] Extracted ${u.palette.length} colors in ${h}ms`),u.palette.length===0)return t.status(200).json({success:!0,colors:[],recipes:[],message:"No significant colors found in SVG (all colors below 1% coverage)"});console.log("[BLEND-RECIPES] Initializing blend solver...");let m=new Y(rt,{maxComponents:a,stepPct:.04,minPct:.1,mode:"parts",parts:{enabled:!0,total:12,minPer:1},preferAnchor:!0});console.log("[BLEND-RECIPES] Generating blend recipes...");let p=[],f=Date.now();for(let x=0;x<u.palette.length;x++){let g=u.palette[x];console.log(`[BLEND-RECIPES]   Color ${x+1}/${u.palette.length}: RGB(${g.rgb.R}, ${g.rgb.G}, ${g.rgb.B}) - ${g.areaPct.toFixed(1)}%`);let B=m.solve(g.lab,3),C=B.map(w=>({parts:w.parts||{},total:w.total||0,deltaE:w.deltaE,quality:w.deltaE<1?"Excellent":w.deltaE<2?"Good":"Fair",resultRgb:w.rgb,components:w.components.map(v=>({code:v.code,name:rt.find(M=>M.code===v.code)?.name||v.code,weight:v.pct,parts:w.parts?w.parts[v.code]:null}))}));console.log(`[BLEND-RECIPES]     Best \u0394E: ${B[0].deltaE.toFixed(2)} (${C[0].quality})`),p.push({targetColor:{hex:wt(g.rgb),rgb:g.rgb,lab:g.lab,areaPct:g.areaPct},blends:C})}let b=Date.now()-f,R=Date.now()-o;console.log(`[BLEND-RECIPES] Generated ${p.length} recipe sets in ${b}ms (total: ${R}ms)`);let d=u.palette.map(x=>({hex:wt(x.rgb),rgb:x.rgb,lab:x.lab,areaPct:x.areaPct}));return t.status(200).json({success:!0,colors:d,recipes:p,metadata:{colorsExtracted:u.palette.length,extractionTime:h,solveTime:b,totalTime:R,maxComponents:a}})}catch(n){return console.error("[BLEND-RECIPES] Error:",n),console.error(n.stack),t.status(500).json({success:!1,error:n.message||"Internal server error",stack:process.env.NODE_ENV==="development"?n.stack:void 0})}}function wt(s){let t=n=>Math.round(n).toString(16).padStart(2,"0");return`#${t(s.R)}${t(s.G)}${t(s.B)}`}var Ie={api:{bodyParser:{sizeLimit:"2mb"},responseLimit:"4mb",externalResolver:!1},maxDuration:60};export{Ie as config,Nt as default};
