<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Current Sanity Data</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 20px; 
            background: #f8fafc; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { color: #1a365d; margin-bottom: 20px; }
        .log { 
            background: #f0f8ff; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0; 
            height: 600px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #e2e8f0;
        }
        button { 
            background: #ff6b35; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            margin: 10px 5px;
        }
        button:hover { background: #e55a2b; }
        .installation-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .has-images { border-left: 4px solid #4caf50; }
        .no-images { border-left: 4px solid #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Current Sanity Data</h1>
        
        <div>
            <button onclick="checkCurrentData()">Check Current Data</button>
            <button onclick="testSingleUpdate()">Test Single Update</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log">Ready to debug...</div>
    </div>

    <script src="js/sanity-client.js"></script>
    <script>
        // Initialize with stored token
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('sanity_token');
            if (token) {
                sanityClient.setToken(token);
                log('‚úì Using saved API token');
            } else {
                const newToken = prompt('Enter your Sanity API token:');
                if (newToken) {
                    sanityClient.setToken(newToken);
                    localStorage.setItem('sanity_token', newToken);
                    log('‚úì API token configured');
                } else {
                    log('‚ùå No API token provided');
                }
            }
        });

        async function checkCurrentData() {
            log('üîç Checking current Sanity data...');
            
            try {
                // Get first 10 installations with all image fields
                const query = `*[_type == "installation"][0...10] {
                    _id,
                    title,
                    coverImage,
                    gallery,
                    imageReferences,
                    imageCount,
                    coverImagePath,
                    "hasGallery": defined(gallery),
                    "hasCoverImage": defined(coverImage),
                    "hasImageReferences": defined(imageReferences),
                    "hasImageCount": defined(imageCount),
                    "galleryLength": length(gallery),
                    "imageReferencesLength": length(imageReferences)
                }`;
                
                const installations = await sanityClient.query(query);
                
                log(`üìä Found ${installations.length} installations to check:`);
                
                let withOldImages = 0;
                let withNewImages = 0;
                let totalWithImages = 0;
                
                installations.forEach((install, i) => {
                    const title = install.title?.en || 'Untitled';
                    const hasOld = install.hasCoverImage || install.hasGallery;
                    const hasNew = install.hasImageReferences || install.hasImageCount;
                    const hasAny = hasOld || hasNew;
                    
                    if (hasOld) withOldImages++;
                    if (hasNew) withNewImages++;
                    if (hasAny) totalWithImages++;
                    
                    log(`${i + 1}. ${title}`);
                    log(`   ID: ${install._id}`);
                    log(`   Old Images: ${hasOld ? '‚úÖ' : '‚ùå'} (Cover: ${install.hasCoverImage}, Gallery: ${install.galleryLength})`);
                    log(`   New Images: ${hasNew ? '‚úÖ' : '‚ùå'} (Refs: ${install.imageReferencesLength}, Count: ${install.imageCount})`);
                    
                    if (install.imageReferences && install.imageReferences.length > 0) {
                        log(`   Image References: ${install.imageReferences.slice(0, 2).join(', ')}${install.imageReferences.length > 2 ? '...' : ''}`);
                    }
                    
                    if (install.coverImagePath) {
                        log(`   Cover Image Path: ${install.coverImagePath}`);
                    }
                    
                    log('');
                });
                
                log('=== SUMMARY ===');
                log(`Total installations checked: ${installations.length}`);
                log(`With old image fields: ${withOldImages}`);
                log(`With new image fields: ${withNewImages}`);
                log(`With any images: ${totalWithImages}`);
                log(`Without images: ${installations.length - totalWithImages}`);
                
            } catch (error) {
                log(`‚ùå Error checking data: ${error.message}`);
            }
        }
        
        async function testSingleUpdate() {
            log('üß™ Testing single update...');
            
            try {
                // Get first installation
                const installations = await sanityClient.query('*[_type == "installation"][0...1] { _id, title }');
                
                if (installations.length === 0) {
                    log('‚ùå No installations found');
                    return;
                }
                
                const testInstall = installations[0];
                const title = testInstall.title?.en || 'Untitled';
                
                log(`üìù Testing update on: ${title}`);
                log(`   ID: ${testInstall._id}`);
                
                // Try to update with test data
                const testData = {
                    imageReferences: ['images/installations/test-1.jpg', 'images/installations/test-2.jpg'],
                    imageCount: 2,
                    coverImagePath: 'images/installations/test-1.jpg'
                };
                
                log('   Attempting update...');
                
                const result = await sanityClient.updateInstallation(testInstall._id, testData);
                
                log('‚úÖ Update successful!');
                log(`   Result: ${JSON.stringify(result, null, 2)}`);
                
                // Verify the update
                log('   Verifying update...');
                const updated = await sanityClient.getInstallation(testInstall._id);
                
                log(`   Verification result:`);
                log(`   - Image Count: ${updated.imageCount || 'Not set'}`);
                log(`   - Image References: ${updated.imageReferences ? updated.imageReferences.length + ' items' : 'Not set'}`);
                log(`   - Cover Image Path: ${updated.coverImagePath || 'Not set'}`);
                
            } catch (error) {
                log(`‚ùå Update failed: ${error.message}`);
                if (error.response) {
                    log(`   Response: ${JSON.stringify(error.response, null, 2)}`);
                }
            }
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...';
        }
    </script>
</body>
</html>