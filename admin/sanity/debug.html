<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanity Connection Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .log { background: #f0f0f0; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sanity API Connection Debug</h1>
        
        <div>
            <h3>Step 1: API Token</h3>
            <input type="password" id="token-input" placeholder="Enter your Sanity API token">
            <button onclick="setToken()">Set Token</button>
            <div id="token-status" class="log">No token set</div>
        </div>

        <div>
            <h3>Step 2: Test Basic Connection</h3>
            <button onclick="testBasicFetch()">Test Basic Fetch</button>
            <div id="fetch-result" class="log">Not tested yet</div>
        </div>

        <div>
            <h3>Step 3: Test with CORS</h3>
            <button onclick="testCors()">Test CORS Headers</button>
            <div id="cors-result" class="log">Not tested yet</div>
        </div>

        <div>
            <h3>Step 4: Test Query</h3>
            <button onclick="testQuery()">Test Simple Query</button>
            <div id="query-result" class="log">Not tested yet</div>
        </div>

        <div>
            <h3>Debug Information</h3>
            <pre id="debug-info">
Project ID: 68ola3dd
Dataset: production
API Version: 2023-05-03
Base URL: https://68ola3dd.api.sanity.io/v2023-05-03
Current Domain: <span id="current-domain"></span>
User Agent: <span id="user-agent"></span>
            </pre>
        </div>
    </div>

    <script>
        let apiToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-domain').textContent = window.location.origin;
            document.getElementById('user-agent').textContent = navigator.userAgent;
            
            // Try to load saved token
            const savedToken = localStorage.getItem('sanity_token');
            if (savedToken) {
                document.getElementById('token-input').value = savedToken;
                apiToken = savedToken;
                document.getElementById('token-status').innerHTML = '<span style="color: green;">✓ Token loaded from localStorage</span>';
                document.getElementById('token-status').className = 'log success';
            }
        });

        function setToken() {
            const token = document.getElementById('token-input').value.trim();
            if (!token) {
                updateStatus('token-status', 'Please enter a token', 'error');
                return;
            }
            
            apiToken = token;
            localStorage.setItem('sanity_token', token);
            updateStatus('token-status', '✓ Token set successfully', 'success');
        }

        async function testBasicFetch() {
            if (!apiToken) {
                updateStatus('fetch-result', 'Please set API token first', 'error');
                return;
            }

            updateStatus('fetch-result', 'Testing basic fetch...', 'info');
            
            try {
                const url = 'https://68ola3dd.api.sanity.io/v2023-05-03/data/query/production?query=*%5B_type%20%3D%3D%20%22installation%22%5D%5B0%5D._id';
                console.log('Testing URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Response data:', data);
                
                updateStatus('fetch-result', `✓ Success! Status: ${response.status}, Result: ${JSON.stringify(data.result)}`, 'success');
                
            } catch (error) {
                console.error('Fetch error:', error);
                updateStatus('fetch-result', `✗ Error: ${error.message}`, 'error');
                
                // Additional debug info
                if (error.message === 'Failed to fetch') {
                    updateStatus('fetch-result', 
                        `✗ Network Error: This could be:\n` +
                        `1. CORS policy blocking the request\n` +
                        `2. Network connectivity issue\n` +
                        `3. Invalid API endpoint\n` +
                        `4. Firewall blocking the request\n\n` +
                        `Check the browser's Network tab in DevTools for more details.`, 'error');
                }
            }
        }

        async function testCors() {
            updateStatus('cors-result', 'Testing CORS preflight...', 'info');
            
            try {
                // Test with OPTIONS request first
                const url = 'https://68ola3dd.api.sanity.io/v2023-05-03/data/query/production';
                
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Authorization, Content-Type'
                    }
                });

                console.log('CORS preflight response:', response.status);
                console.log('CORS headers:', [...response.headers.entries()]);

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                updateStatus('cors-result', 
                    `CORS Preflight Status: ${response.status}\n` +
                    `Allow-Origin: ${corsHeaders['Access-Control-Allow-Origin']}\n` +
                    `Allow-Methods: ${corsHeaders['Access-Control-Allow-Methods']}\n` +
                    `Allow-Headers: ${corsHeaders['Access-Control-Allow-Headers']}`, 
                    response.status < 400 ? 'success' : 'error');

            } catch (error) {
                console.error('CORS test error:', error);
                updateStatus('cors-result', `✗ CORS Test Failed: ${error.message}`, 'error');
            }
        }

        async function testQuery() {
            if (!apiToken) {
                updateStatus('query-result', 'Please set API token first', 'error');
                return;
            }

            updateStatus('query-result', 'Testing Sanity query...', 'info');
            
            try {
                const query = '*[_type == "installation"][0]._id';
                const url = `https://68ola3dd.api.sanity.io/v2023-05-03/data/query/production?query=${encodeURIComponent(query)}`;
                
                console.log('Query URL:', url);
                console.log('Query:', query);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Query result:', result);
                
                updateStatus('query-result', 
                    `✓ Query Successful!\n` +
                    `Query: ${query}\n` +
                    `Result: ${JSON.stringify(result, null, 2)}`, 'success');

            } catch (error) {
                console.error('Query error:', error);
                updateStatus('query-result', `✗ Query Failed: ${error.message}`, 'error');
            }
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `log ${type}`;
        }

        // Test different endpoints
        async function testAlternativeEndpoint() {
            try {
                // Try the CDN endpoint instead
                const url = 'https://68ola3dd.apicdn.sanity.io/v2023-05-03/data/query/production?query=*%5B_type%20%3D%3D%20%22installation%22%5D%5B0%5D._id';
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });

                console.log('CDN endpoint response:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('CDN endpoint data:', data);
                    updateStatus('query-result', `✓ CDN Endpoint works! Result: ${JSON.stringify(data.result)}`, 'success');
                }
                
            } catch (error) {
                console.error('CDN endpoint error:', error);
            }
        }
    </script>
</body>
</html>