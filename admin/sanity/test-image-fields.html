<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Field Updates</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 20px; 
            background: #f8fafc; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { color: #1a365d; margin-bottom: 20px; }
        .log { 
            background: #f0f8ff; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0; 
            height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #e2e8f0;
        }
        button { 
            background: #ff6b35; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            margin: 10px 5px;
        }
        button:hover { background: #e55a2b; }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .status { 
            padding: 15px; 
            border-radius: 6px; 
            margin: 10px 0; 
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Image Field Updates</h1>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div>
            <button onclick="runTest()" id="testBtn">Run Test</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log">Ready to test image field updates...</div>
    </div>

    <script src="js/sanity-client.js"></script>
    <script>
        // Initialize with stored token
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('sanity_token');
            if (token) {
                sanityClient.setToken(token);
                log('‚úì Using saved API token');
                showStatus('Token loaded from localStorage', 'success');
            } else {
                const newToken = prompt('Enter your Sanity API token:');
                if (newToken) {
                    sanityClient.setToken(newToken);
                    localStorage.setItem('sanity_token', newToken);
                    log('‚úì API token configured');
                    showStatus('New token configured and saved', 'success');
                } else {
                    log('‚ùå No API token provided');
                    showStatus('No API token provided - test cannot run', 'error');
                }
            }
        });

        async function runTest() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Running Test...';
            
            log('üß™ Starting image field update test...');
            
            try {
                // Find an installation to test
                log('üìñ Finding installation to test...');
                
                const query = `*[_type == "installation"][0...1] {
                    _id,
                    title,
                    imageReferences,
                    imageCount,
                    coverImagePath
                }`;
                
                const installations = await sanityClient.query(query);
                
                if (!installations || installations.length === 0) {
                    log('‚ùå No installations found in Sanity');
                    showStatus('No installations found to test with', 'error');
                    return;
                }
                
                const testInstallation = installations[0];
                const title = testInstallation.title?.en || 'Untitled';
                
                log(`‚úì Found installation to test: "${title}"`);
                log(`  ID: ${testInstallation._id}`);
                log(`  Current imageReferences: ${testInstallation.imageReferences ? testInstallation.imageReferences.length + ' items' : 'Not set'}`);
                log(`  Current imageCount: ${testInstallation.imageCount || 'Not set'}`);
                log(`  Current coverImagePath: ${testInstallation.coverImagePath || 'Not set'}`);
                
                // Prepare test data
                const testImageData = {
                    imageReferences: [
                        'images/installations/test-image-1.jpg',
                        'images/installations/test-image-2.jpg',
                        'images/installations/test-image-3.jpg'
                    ],
                    imageCount: 3,
                    coverImagePath: 'images/installations/test-image-1.jpg'
                };
                
                log('\nüîÑ Attempting to update image fields...');
                log(`  Setting imageReferences: [${testImageData.imageReferences.join(', ')}]`);
                log(`  Setting imageCount: ${testImageData.imageCount}`);
                log(`  Setting coverImagePath: ${testImageData.coverImagePath}`);
                
                // Perform the update using sanityClient.updateInstallation
                const result = await sanityClient.updateInstallation(testInstallation._id, testImageData);
                
                log('‚úÖ Update successful!');
                log(`  Result: ${JSON.stringify(result, null, 2)}`);
                
                // Verify the update
                log('\nüîç Verifying update...');
                const updated = await sanityClient.getInstallation(testInstallation._id);
                
                if (updated) {
                    log('‚úÖ Verification successful!');
                    log(`  Title: ${updated.title?.en || 'Untitled'}`);
                    log(`  ImageReferences: ${updated.imageReferences ? updated.imageReferences.length + ' items' : 'Not set'}`);
                    log(`  ImageCount: ${updated.imageCount || 'Not set'}`);
                    log(`  CoverImagePath: ${updated.coverImagePath || 'Not set'}`);
                    
                    if (updated.imageReferences && updated.imageReferences.length > 0) {
                        log(`  First image: ${updated.imageReferences[0]}`);
                    }
                    
                    // Check if the update was successful
                    const isSuccessful = 
                        updated.imageReferences && 
                        updated.imageReferences.length === testImageData.imageCount &&
                        updated.imageCount === testImageData.imageCount &&
                        updated.coverImagePath === testImageData.coverImagePath;
                    
                    if (isSuccessful) {
                        log('\nüéâ Test PASSED! Image fields can be updated successfully.');
                        log('‚úÖ Ready to run the full migration script.');
                        showStatus('Test PASSED - Image fields update successfully', 'success');
                    } else {
                        log('\n‚ùå Test FAILED! Data mismatch detected.');
                        log('Expected vs Actual:');
                        log(`  ImageCount: ${testImageData.imageCount} vs ${updated.imageCount}`);
                        log(`  CoverImagePath: ${testImageData.coverImagePath} vs ${updated.coverImagePath}`);
                        log(`  ImageReferences length: ${testImageData.imageReferences.length} vs ${updated.imageReferences ? updated.imageReferences.length : 0}`);
                        showStatus('Test FAILED - Data mismatch detected', 'error');
                    }
                } else {
                    log('‚ùå Failed to verify update - document not found');
                    showStatus('Verification failed - document not found', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`);
                if (error.details) {
                    log(`  Details: ${JSON.stringify(error.details, null, 2)}`);
                }
                showStatus(`Test failed: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Run Test';
            }
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...';
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
    </script>
</body>
</html>