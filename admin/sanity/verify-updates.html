<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Image Updates</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 20px; 
            background: #f8fafc; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { color: #1a365d; margin-bottom: 20px; }
        .log { 
            background: #f0f8ff; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0; 
            height: 600px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #e2e8f0;
        }
        button { 
            background: #ff6b35; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            margin: 10px 5px;
        }
        button:hover { background: #e55a2b; }
        .test-result {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verify Image Updates</h1>
        
        <div>
            <button onclick="testCompleteFlow()">üß™ Test Complete Flow</button>
            <button onclick="checkCurrentState()">üìä Check Current State</button>
            <button onclick="testManualUpdate()">‚úèÔ∏è Manual Test Update</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
        
        <div id="log" class="log">Ready to verify image updates...</div>
    </div>

    <script src="js/sanity-client.js"></script>
    <script>
        // Initialize with stored token
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('sanity_token');
            if (token) {
                sanityClient.setToken(token);
                log('‚úì Using saved API token');
            } else {
                const newToken = prompt('Enter your Sanity API token:');
                if (newToken) {
                    sanityClient.setToken(newToken);
                    localStorage.setItem('sanity_token', newToken);
                    log('‚úì API token configured');
                } else {
                    log('‚ùå No API token provided');
                }
            }
        });

        async function testCompleteFlow() {
            log('üß™ Testing complete flow: Schema ‚Üí Update ‚Üí Verify ‚Üí Display');
            
            try {
                // Step 1: Check schema fields exist
                log('\\n1Ô∏è‚É£ Testing schema fields...');
                const testInstall = await sanityClient.query('*[_type == "installation"][0] { _id, title, imageReferences, imageCount, coverImagePath }');
                
                if (testInstall.length === 0) {
                    log('‚ùå No installations found');
                    return;
                }
                
                const install = testInstall[0];
                log(`   Found installation: ${install.title?.en || 'Untitled'}`);
                log(`   Current imageReferences: ${install.imageReferences || 'null'}`);
                log(`   Current imageCount: ${install.imageCount || 'null'}`);
                log(`   Current coverImagePath: ${install.coverImagePath || 'null'}`);
                
                // Step 2: Try update
                log('\\n2Ô∏è‚É£ Testing update...');
                const testData = {
                    imageReferences: ['images/installations/test1.jpg', 'images/installations/test2.jpg'],
                    imageCount: 2,
                    coverImagePath: 'images/installations/test1.jpg'
                };
                
                log(`   Updating with test data...`);
                const updateResult = await sanityClient.updateInstallation(install._id, testData);
                log(`   Update result: ${JSON.stringify(updateResult.operation || 'success')}`);
                
                // Step 3: Verify update
                log('\\n3Ô∏è‚É£ Verifying update...');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for Sanity to process
                
                const verified = await sanityClient.query(`*[_type == "installation" && _id == "${install._id}"][0] {
                    _id, title, imageReferences, imageCount, coverImagePath
                }`);
                
                log(`   After update:`);
                log(`   - imageReferences: ${JSON.stringify(verified.imageReferences)}`);
                log(`   - imageCount: ${verified.imageCount}`);
                log(`   - coverImagePath: ${verified.coverImagePath}`);
                
                // Step 4: Test admin interface logic
                log('\\n4Ô∏è‚É£ Testing admin interface logic...');
                const imageCount = verified.imageCount || 
                    (verified.gallery && verified.gallery.length ? verified.gallery.length : 0) + 
                    (verified.coverImage ? 1 : 0) ||
                    (verified.imageReferences ? verified.imageReferences.length : 0);
                
                log(`   Calculated image count: ${imageCount}`);
                
                if (imageCount > 0) {
                    log('\\n‚úÖ SUCCESS: Complete flow working!');
                    log(`   The installation now has ${imageCount} images`);
                    log(`   Admin interface should show this count`);
                } else {
                    log('\\n‚ùå FAILURE: Image count still 0');
                    log('   Something is wrong with the admin interface logic');
                }
                
            } catch (error) {
                log(`‚ùå Flow test failed: ${error.message}`);
                console.error(error);
            }
        }
        
        async function checkCurrentState() {
            log('üìä Checking current state of installations...');
            
            try {
                const installations = await sanityClient.query(`
                    *[_type == "installation"][0...5] {
                        _id,
                        title,
                        coverImage,
                        gallery,
                        imageReferences,
                        imageCount,
                        coverImagePath,
                        "galleryLength": length(gallery),
                        "imageReferencesLength": length(imageReferences)
                    }
                `);
                
                log(`Found ${installations.length} installations:\\n`);
                
                let withOldImages = 0;
                let withNewImages = 0;
                let totalImageCount = 0;
                
                installations.forEach((install, i) => {
                    const title = install.title?.en || 'Untitled';
                    const hasOld = install.coverImage || (install.gallery && install.gallery.length > 0);
                    const hasNew = install.imageReferences && install.imageReferences.length > 0;
                    
                    if (hasOld) withOldImages++;
                    if (hasNew) withNewImages++;
                    
                    // Calculate total using admin interface logic
                    const calculatedCount = install.imageCount || 
                        (install.gallery && install.gallery.length ? install.gallery.length : 0) + 
                        (install.coverImage ? 1 : 0) ||
                        (install.imageReferences ? install.imageReferences.length : 0);
                    
                    totalImageCount += calculatedCount;
                    
                    log(`${i + 1}. ${title}`);
                    log(`   Old format: ${hasOld ? '‚úÖ' : '‚ùå'} (${install.galleryLength || 0} gallery)`);
                    log(`   New format: ${hasNew ? '‚úÖ' : '‚ùå'} (${install.imageReferencesLength || 0} refs)`);
                    log(`   Calculated count: ${calculatedCount}`);
                    if (install.imageReferences) {
                        log(`   Sample images: ${install.imageReferences.slice(0, 2).join(', ')}`);
                    }
                    log('');
                });
                
                log(`=== SUMMARY ===`);
                log(`Installations with old images: ${withOldImages}`);
                log(`Installations with new images: ${withNewImages}`);
                log(`Total calculated image count: ${totalImageCount}`);
                
                if (withNewImages === 0) {
                    log('\\n‚ö†Ô∏è WARNING: No installations have new image format data');
                    log('   This suggests the updates aren\\'t being saved properly');
                } else {
                    log(`\\n‚úÖ Found ${withNewImages} installations with new image data`);
                }
                
            } catch (error) {
                log(`‚ùå State check failed: ${error.message}`);
            }
        }
        
        async function testManualUpdate() {
            log('‚úèÔ∏è Testing manual update...');
            
            try {
                // Get first installation
                const installations = await sanityClient.query('*[_type == "installation"][0...1] { _id, title }');
                
                if (installations.length === 0) {
                    log('‚ùå No installations found');
                    return;
                }
                
                const install = installations[0];
                log(`Manual test on: ${install.title?.en || 'Untitled'}`);
                
                // Try direct API call
                const result = await sanityClient.apiRequest(`/data/mutate/${sanityClient.dataset}?returnIds=true&returnDocuments=true`, {
                    method: 'POST',
                    body: JSON.stringify({
                        mutations: [{
                            patch: {
                                id: install._id,
                                set: {
                                    imageReferences: ['manual-test-1.jpg', 'manual-test-2.jpg'],
                                    imageCount: 2,
                                    coverImagePath: 'manual-test-1.jpg'
                                }
                            }
                        }]
                    })
                });
                
                log('‚úÖ Manual API call successful');
                log(`Result: ${JSON.stringify(result, null, 2)}`);
                
                // Verify
                const verified = await sanityClient.getInstallation(install._id);
                log(`\\nVerification:`);
                log(`- imageReferences: ${JSON.stringify(verified.imageReferences)}`);
                log(`- imageCount: ${verified.imageCount}`);
                log(`- coverImagePath: ${verified.coverImagePath}`);
                
            } catch (error) {
                log(`‚ùå Manual test failed: ${error.message}`);
                console.error(error);
            }
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...';
        }
    </script>
</body>
</html>