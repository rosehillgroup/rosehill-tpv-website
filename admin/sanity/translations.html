<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Management - Rosehill TPV Admin (Sanity)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .admin-header {
            background: linear-gradient(135deg, #1a365d, #2d4a71);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .admin-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-button {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-decoration: none;
            color: #64748b;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-button:hover {
            border-color: #ff6b35;
            color: #ff6b35;
        }

        .nav-button.active {
            background: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        /* Installation Selection */
        .selection-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .selection-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a365d;
        }

        .search-box {
            position: relative;
            max-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            width: 16px;
            height: 16px;
        }

        .installation-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .installation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .installation-item:hover {
            background: #f8fafc;
        }

        .installation-item.selected {
            background: #fef3f2;
            border-left: 3px solid #ff6b35;
        }

        .installation-info h4 {
            font-size: 16px;
            font-weight: 500;
            color: #1a365d;
            margin-bottom: 2px;
        }

        .installation-info p {
            font-size: 14px;
            color: #64748b;
        }

        .translation-summary {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .lang-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .lang-en { background: #10b981; }
        .lang-fr { background: #3b82f6; }
        .lang-de { background: #f59e0b; }
        .lang-es { background: #ef4444; }

        /* Translation Management */
        .translation-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            display: none;
        }

        .translation-section.active {
            display: block;
        }

        .translation-header {
            padding: 25px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .translation-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 8px;
        }

        .translation-header p {
            color: #64748b;
            font-size: 14px;
        }

        .translation-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .translation-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .translation-tab:hover {
            color: #ff6b35;
            background: #fef7f5;
        }

        .translation-tab.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
            background: #fef7f5;
        }

        .flag-icon {
            width: 16px;
            height: 12px;
            border-radius: 2px;
        }

        .flag-en { background: linear-gradient(to bottom, #012169 33%, #fff 33%, #fff 66%, #c8102e 66%); }
        .flag-fr { background: linear-gradient(to right, #002654 33%, #fff 33%, #fff 66%, #ed2939 66%); }
        .flag-de { background: linear-gradient(to bottom, #000 33%, #dd0000 33%, #dd0000 66%, #ffce00 66%); }
        .flag-es { background: linear-gradient(to bottom, #aa151b 25%, #f1bf00 25%, #f1bf00 75%, #aa151b 75%); }

        .translation-content {
            padding: 30px;
        }

        .field-group {
            margin-bottom: 25px;
        }

        .field-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .field-group input,
        .field-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .field-group input:focus,
        .field-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .field-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .field-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .field-comparison .field-group {
            margin-bottom: 0;
        }

        .field-comparison .original {
            opacity: 0.7;
        }

        .field-comparison .original input,
        .field-comparison .original textarea {
            background: #f8fafc;
            border-color: #d1d5db;
        }

        /* Translation Status */
        .status-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1a365d;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-not-started {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-machine-translated {
            background: #fef3c7;
            color: #92400e;
        }

        .status-human-reviewed {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-published {
            background: #dcfce7;
            color: #166534;
        }

        .status-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #ff6b35;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a2b;
        }

        .btn-secondary {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Bulk Actions */
        .bulk-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .bulk-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bulk-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a365d;
        }

        .bulk-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Loading and Messages */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .message-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .message-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 20px 15px;
            }

            .field-comparison {
                grid-template-columns: 1fr;
            }

            .status-actions,
            .bulk-actions {
                justify-content: center;
            }

            .translation-tabs {
                overflow-x: auto;
            }

            .translation-tab {
                min-width: 120px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <h1>Translation Management</h1>
        <p>Manage translations for installation showcases using Sanity CMS and DeepL</p>
    </header>

    <main class="admin-container">
        <!-- Navigation -->
        <nav class="admin-nav">
            <a href="add-installation.html" class="nav-button">Add Installation</a>
            <a href="manage-installations.html" class="nav-button">Manage Installations</a>
            <a href="translations.html" class="nav-button active">Translations</a>
            <a href="../../installations.html" class="nav-button" target="_blank">View Live</a>
        </nav>

        <!-- Messages -->
        <div id="message-container"></div>

        <!-- Bulk Actions -->
        <section class="bulk-section">
            <div class="bulk-header">
                <h3>Bulk Translation Actions</h3>
            </div>
            <div class="bulk-actions">
                <button id="bulk-translate-fr" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.87,15.07L15.27,12.67L16.68,14.08L17.39,13.37L15.27,11.25L12.87,13.65L10.47,11.25L9.06,12.66L12.87,16.47L16.68,12.66L15.27,11.25L12.87,13.65L12.87,15.07Z" />
                    </svg>
                    Translate All to French
                </button>
                <button id="bulk-translate-de" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.87,15.07L15.27,12.67L16.68,14.08L17.39,13.37L15.27,11.25L12.87,13.65L10.47,11.25L9.06,12.66L12.87,16.47L16.68,12.66L15.27,11.25L12.87,13.65L12.87,15.07Z" />
                    </svg>
                    Translate All to German
                </button>
                <button id="bulk-translate-es" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.87,15.07L15.27,12.67L16.68,14.08L17.39,13.37L15.27,11.25L12.87,13.65L10.47,11.25L9.06,12.66L12.87,16.47L16.68,12.66L15.27,11.25L12.87,13.65L12.87,15.07Z" />
                    </svg>
                    Translate All to Spanish
                </button>
                <button id="regenerate-pages" class="btn btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65,6.35A7.958,7.958,0,0,0,12,4c-4.42,0-7.99,3.58-7.99,8s3.57,8,7.99,8c3.73,0,6.84-2.55,7.73-6h-2.08A5.99,5.99,0,0,1,12,18c-3.31,0-6-2.69-6-6s2.69-6,6-6c1.66,0,3.14,.69,4.22,1.78L13,11h7V4l-2.35,2.35Z" />
                    </svg>
                    Regenerate All Pages
                </button>
            </div>
        </section>

        <!-- Installation Selection -->
        <section class="selection-section">
            <div class="selection-header">
                <h3>Select Installation</h3>
                <div class="search-box">
                    <input type="text" id="installation-search" class="search-input" placeholder="Search installations...">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
                    </svg>
                </div>
            </div>
            <div class="installation-list" id="installation-list">
                <!-- Installation items will be loaded here -->
            </div>
        </section>

        <!-- Translation Management -->
        <section class="translation-section" id="translation-section">
            <div class="translation-header">
                <h3 id="selected-title">Select an installation to manage translations</h3>
                <p id="selected-subtitle">Choose an installation from the list above</p>
            </div>

            <div class="translation-tabs">
                <button class="translation-tab active" data-lang="fr">
                    <div class="flag-icon flag-fr"></div>
                    French
                </button>
                <button class="translation-tab" data-lang="de">
                    <div class="flag-icon flag-de"></div>
                    German
                </button>
                <button class="translation-tab" data-lang="es">
                    <div class="flag-icon flag-es"></div>
                    Spanish
                </button>
            </div>

            <div class="translation-content" id="translation-content">
                <!-- Translation content will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loading-title">Processing...</h3>
            <p id="loading-subtitle">Please wait while we process your request</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/sanity-client.js"></script>
    <script>
        // Global variables
        let installations = [];
        let selectedInstallation = null;
        let currentLanguage = 'fr';

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAndSetupAuth();
            await loadInstallations();
            setupEventListeners();
            
            // Check if specific installation is requested
            const params = new URLSearchParams(window.location.search);
            const installationId = params.get('id');
            if (installationId) {
                selectInstallationById(installationId);
            }
        });

        // Check for authentication
        async function checkAndSetupAuth() {
            let token = localStorage.getItem('sanity_token');
            
            if (!token) {
                token = prompt('Please enter your Sanity API token:');
                if (!token) {
                    alert('API token is required to use the admin interface.');
                    return;
                }
                localStorage.setItem('sanity_token', token);
            }

            sanityClient.setToken(token);

            try {
                await sanityClient.query('*[_type == "installation"][0]._id');
            } catch (error) {
                localStorage.removeItem('sanity_token');
                alert('Invalid API token. Please refresh and try again.');
                throw error;
            }
        }

        // Load installations
        async function loadInstallations() {
            try {
                installations = await sanityClient.getInstallations({
                    sortBy: 'title',
                    sortOrder: 'asc'
                });
                renderInstallationList();
            } catch (error) {
                console.error('Error loading installations:', error);
                showMessage('Error loading installations', 'error');
            }
        }

        // Render installation list
        function renderInstallationList(filter = '') {
            const listContainer = document.getElementById('installation-list');
            
            const filteredInstallations = installations.filter(inst => {
                const title = inst.title?.en || '';
                const city = inst.location?.city?.en || '';
                const country = inst.location?.country?.en || '';
                const searchText = `${title} ${city} ${country}`.toLowerCase();
                return searchText.includes(filter.toLowerCase());
            });

            listContainer.innerHTML = filteredInstallations.map(installation => {
                const title = installation.title?.en || 'Untitled';
                const city = installation.location?.city?.en || 'Unknown';
                const country = installation.location?.country?.en || 'Location';
                const publishedLocales = installation.publishedLocales || ['en'];
                
                const langDots = ['en', 'fr', 'de', 'es'].map(lang => 
                    `<div class="lang-dot lang-${lang}" title="${lang.toUpperCase()}: ${
                        publishedLocales.includes(lang) ? 'Published' : 'Not translated'
                    }"></div>`
                ).join('');

                return `
                    <div class="installation-item ${selectedInstallation?._id === installation._id ? 'selected' : ''}" 
                         onclick="selectInstallation('${installation._id}')">
                        <div class="installation-info">
                            <h4>${title}</h4>
                            <p>${city}, ${country}</p>
                        </div>
                        <div class="translation-summary">
                            ${langDots}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select installation
        function selectInstallation(installationId) {
            selectedInstallation = installations.find(inst => inst._id === installationId);
            if (!selectedInstallation) return;

            // Update UI
            renderInstallationList(document.getElementById('installation-search').value);
            loadTranslationInterface();
        }

        // Select installation by ID (for direct links)
        function selectInstallationById(installationId) {
            const installation = installations.find(inst => inst._id === installationId);
            if (installation) {
                selectInstallation(installationId);
            }
        }

        // Load translation interface
        function loadTranslationInterface() {
            if (!selectedInstallation) return;

            const title = selectedInstallation.title?.en || 'Untitled';
            const city = selectedInstallation.location?.city?.en || 'Unknown';
            const country = selectedInstallation.location?.country?.en || 'Location';

            document.getElementById('selected-title').textContent = `Translations for "${title}"`;
            document.getElementById('selected-subtitle').textContent = `${city}, ${country}`;
            document.getElementById('translation-section').classList.add('active');

            loadLanguageContent(currentLanguage);
        }

        // Load language content
        function loadLanguageContent(language) {
            if (!selectedInstallation) return;

            const content = document.getElementById('translation-content');
            const translationStatus = selectedInstallation.translationStatus?.[language] || 'not-started';
            
            content.innerHTML = `
                <div class="status-section">
                    <div class="status-header">
                        <h4>Translation Status: ${language.toUpperCase()}</h4>
                        <span class="status-badge status-${translationStatus}">${translationStatus.replace('-', ' ')}</span>
                    </div>
                    <div class="status-actions">
                        <button class="btn btn-primary" onclick="translateToLanguage('${language}')" ${translationStatus === 'published' ? 'disabled' : ''}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12.87,15.07L15.27,12.67L16.68,14.08L17.39,13.37L15.27,11.25L12.87,13.65L10.47,11.25L9.06,12.66L12.87,16.47L16.68,12.66L15.27,11.25L12.87,13.65L12.87,15.07Z" />
                            </svg>
                            Machine Translate
                        </button>
                        <button class="btn btn-warning" onclick="markAsReviewed('${language}')" ${translationStatus !== 'machine-translated' ? 'disabled' : ''}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" />
                            </svg>
                            Mark as Reviewed
                        </button>
                        <button class="btn btn-success" onclick="publishTranslation('${language}')" ${translationStatus !== 'human-reviewed' ? 'disabled' : ''}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5,4V7H10.5V19H13.5V7H19V4H5Z" />
                            </svg>
                            Publish
                        </button>
                    </div>
                </div>

                <div class="field-comparison">
                    <div class="field-group original">
                        <label>Title (Original - English)</label>
                        <input type="text" value="${selectedInstallation.title?.en || ''}" readonly>
                    </div>
                    <div class="field-group">
                        <label>Title (${language.toUpperCase()})</label>
                        <input type="text" id="title-${language}" value="${selectedInstallation.title?.[language] || ''}" 
                               onchange="updateTranslation('title', '${language}', this.value)">
                    </div>
                </div>

                <div class="field-comparison">
                    <div class="field-group original">
                        <label>City (Original - English)</label>
                        <input type="text" value="${selectedInstallation.location?.city?.en || ''}" readonly>
                    </div>
                    <div class="field-group">
                        <label>City (${language.toUpperCase()})</label>
                        <input type="text" id="city-${language}" value="${selectedInstallation.location?.city?.[language] || ''}"
                               onchange="updateTranslation('location.city', '${language}', this.value)">
                    </div>
                </div>

                <div class="field-comparison">
                    <div class="field-group original">
                        <label>Country (Original - English)</label>
                        <input type="text" value="${selectedInstallation.location?.country?.en || ''}" readonly>
                    </div>
                    <div class="field-group">
                        <label>Country (${language.toUpperCase()})</label>
                        <input type="text" id="country-${language}" value="${selectedInstallation.location?.country?.[language] || ''}"
                               onchange="updateTranslation('location.country', '${language}', this.value)">
                    </div>
                </div>

                <div class="field-comparison">
                    <div class="field-group original">
                        <label>Overview (Original - English)</label>
                        <textarea readonly>${selectedInstallation.overview?.en || ''}</textarea>
                    </div>
                    <div class="field-group">
                        <label>Overview (${language.toUpperCase()})</label>
                        <textarea id="overview-${language}" onchange="updateTranslation('overview', '${language}', this.value)">${selectedInstallation.overview?.[language] || ''}</textarea>
                    </div>
                </div>
            `;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Installation search
            document.getElementById('installation-search').addEventListener('input', (e) => {
                renderInstallationList(e.target.value);
            });

            // Translation tabs
            document.querySelectorAll('.translation-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    document.querySelectorAll('.translation-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Load language content
                    currentLanguage = tab.dataset.lang;
                    loadLanguageContent(currentLanguage);
                });
            });

            // Bulk action buttons
            document.getElementById('bulk-translate-fr').addEventListener('click', () => bulkTranslate('fr'));
            document.getElementById('bulk-translate-de').addEventListener('click', () => bulkTranslate('de'));
            document.getElementById('bulk-translate-es').addEventListener('click', () => bulkTranslate('es'));
            document.getElementById('regenerate-pages').addEventListener('click', regenerateAllPages);
        }

        // Translate to specific language
        async function translateToLanguage(language) {
            if (!selectedInstallation) return;

            try {
                showLoading('Translating...', 'Machine translating content using DeepL API');

                // Call translation webhook/function
                const response = await fetch('/.netlify/functions/translate-installation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        installationId: selectedInstallation._id,
                        targetLanguage: language
                    })
                });

                if (!response.ok) {
                    throw new Error(`Translation failed: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Update translation status
                await sanityClient.updateTranslationStatus(selectedInstallation._id, language, 'machine-translated');
                
                // Reload installation data
                selectedInstallation = await sanityClient.getInstallation(selectedInstallation._id);
                loadLanguageContent(language);
                
                showMessage(`Translation to ${language.toUpperCase()} completed successfully!`, 'success');

            } catch (error) {
                console.error('Translation error:', error);
                showMessage('Translation failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Mark as reviewed
        async function markAsReviewed(language) {
            try {
                await sanityClient.updateTranslationStatus(selectedInstallation._id, language, 'human-reviewed');
                selectedInstallation = await sanityClient.getInstallation(selectedInstallation._id);
                loadLanguageContent(language);
                showMessage(`${language.toUpperCase()} translation marked as reviewed`, 'success');
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('Error updating translation status', 'error');
            }
        }

        // Publish translation
        async function publishTranslation(language) {
            try {
                await sanityClient.publishLocale(selectedInstallation._id, language);
                selectedInstallation = await sanityClient.getInstallation(selectedInstallation._id);
                loadLanguageContent(language);
                renderInstallationList(document.getElementById('installation-search').value);
                showMessage(`${language.toUpperCase()} translation published successfully!`, 'success');
            } catch (error) {
                console.error('Error publishing translation:', error);
                showMessage('Error publishing translation', 'error');
            }
        }

        // Update translation field
        async function updateTranslation(field, language, value) {
            if (!selectedInstallation) return;

            try {
                const updateData = {};
                updateData[field.replace('.', '_')] = value; // Simplified for demo
                
                await sanityClient.updateInstallation(selectedInstallation._id, updateData, language);
                showMessage('Translation updated', 'success');
            } catch (error) {
                console.error('Error updating translation:', error);
                showMessage('Error updating translation', 'error');
            }
        }

        // Bulk translate all installations
        async function bulkTranslate(language) {
            if (!confirm(`This will translate all installations to ${language.toUpperCase()}. This may take several minutes. Continue?`)) {
                return;
            }

            try {
                showLoading('Bulk Translating...', `Translating all installations to ${language.toUpperCase()}`);

                const response = await fetch('/.netlify/functions/bulk-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        targetLanguage: language
                    })
                });

                if (!response.ok) {
                    throw new Error(`Bulk translation failed: ${response.statusText}`);
                }

                const result = await response.json();
                
                await loadInstallations(); // Reload data
                showMessage(`Bulk translation to ${language.toUpperCase()} completed! Processed ${result.count} installations.`, 'success');

            } catch (error) {
                console.error('Bulk translation error:', error);
                showMessage('Bulk translation failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Regenerate all pages
        async function regenerateAllPages() {
            if (!confirm('This will regenerate all installation pages. Continue?')) {
                return;
            }

            try {
                showLoading('Regenerating Pages...', 'Regenerating all installation pages from Sanity data');

                const response = await fetch('/api/regenerate-pages', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Page regeneration failed: ${response.statusText}`);
                }

                showMessage('All pages regenerated successfully!', 'success');

            } catch (error) {
                console.error('Page regeneration error:', error);
                showMessage('Page regeneration failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Show loading overlay
        function showLoading(title, subtitle) {
            document.getElementById('loading-title').textContent = title;
            document.getElementById('loading-subtitle').textContent = subtitle;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // Show message
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${type}`;
            messageEl.textContent = message;
            
            container.appendChild(messageEl);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }
    </script>
</body>
</html>