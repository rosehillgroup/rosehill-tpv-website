# Rosehill TPV CMS Migration Guide

## Overview

This guide covers the migration from the complex Supabase-based translation system to a modern, scalable Sanity CMS architecture with automatic machine translation.

## Architecture

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌─────────────┐
│ Sanity CMS  │───▶│ DeepL Webhook│───▶│ Astro Site  │───▶│ Netlify     │
│ (Content)   │    │ (Translation)│    │ (Static)    │    │ (Hosting)   │
└─────────────┘    └──────────────┘    └─────────────┘    └─────────────┘
```

## Key Components

### 1. Sanity Studio (`studio-rosehill-tpv/`)
- **URL**: http://localhost:3333 (development)
- **Purpose**: Content management with field-level localization
- **Features**: 
  - Multi-language content editing
  - Translation status tracking
  - Media management with localized alt text
  - Preview modes

### 2. Astro Site (`site-astro/`)
- **Purpose**: Static site generation with i18n routing
- **Features**:
  - `/` - English installations
  - `/fr/` - French installations  
  - `/de/` - German installations
  - `/es/` - Spanish installations
  - Automatic hreflang generation
  - SEO-optimized pages

### 3. Translation Function (`netlify/functions/translate-installation.js`)
- **Purpose**: Webhook triggered machine translation
- **Features**:
  - DeepL API integration
  - Brand term protection
  - Automatic slug generation
  - Translation status updates

## Environment Variables Required

```bash
# Sanity
SANITY_WRITE_TOKEN=your_sanity_write_token

# DeepL (existing)
DEEPL_API_KEY=be41df2a-742b-4952-ac1c-f94c17f50a44

# Netlify (optional)
NETLIFY_BUILD_HOOK=https://api.netlify.com/build_hooks/your_hook_id
```

## Getting Started

### 1. Start Sanity Studio
```bash
npm run dev:studio
```
Open http://localhost:3333 to access the CMS.

### 2. Start Astro Development Site
```bash
npm run dev:site
```
Open http://localhost:4321 to preview the site.

### 3. Migrate Existing Data
```bash
export SANITY_WRITE_TOKEN="your_token_here"
npm run migrate
```

## Content Workflow

### For Content Editors

1. **Create Installation**: 
   - Go to Sanity Studio
   - Create new Installation document
   - Fill in English content (title, overview, location, etc.)
   - Upload images with English alt text
   - Set installation date and application type

2. **Publish & Translate**:
   - Set "Published Locales" to include target languages
   - Save document
   - Translation webhook automatically creates translations
   - Review and edit machine translations if needed

3. **Content Review**:
   - Check "Translation Status" field
   - Edit machine translations for accuracy
   - Update status to "Human Reviewed" when complete

### Translation Status Workflow

- **Not Started**: No translation exists
- **Machine Translated**: Auto-generated by DeepL
- **Human Reviewed**: Edited and approved by human
- **Published**: Live on the website

## Comparison: Old vs New System

| Feature | Old System (Supabase) | New System (Sanity) |
|---------|----------------------|---------------------|
| **Content Entry** | Database admin tools | Visual CMS interface |
| **Translations** | Complex JSON + regex replacement | Field-level localization |
| **Workflow** | Manual HTML generation | Automated static generation |
| **SEO** | Manual meta tag management | Automatic hreflang + sitemaps |
| **Preview** | No preview | Live preview with drafts |
| **Media** | Manual image optimization | Automatic image optimization |
| **Version Control** | No versioning | Built-in content versioning |
| **Collaboration** | Single user | Multi-user with permissions |

## Migration Benefits

### ✅ **Solved Pain Points**
- **No more regex HTML manipulation**
- **No JSON translation gymnastics** 
- **No complex build-time translation logic**
- **No fragile caching systems**
- **Proper editorial interface**
- **Real-time collaboration**
- **Content versioning and history**
- **Preview functionality**

### ✅ **New Capabilities**
- **One-click translation** - Write in English, auto-translate
- **Human editing** - Refine machine translations
- **Media localization** - Localized alt text and captions
- **SEO optimization** - Automatic meta tags and hreflang
- **Performance** - Static generation, CDN-ready
- **Scalability** - Add new languages easily

## Deployment

### Netlify Configuration
Update your `netlify.toml`:
```toml
[build]
  publish = "site-astro/dist"
  command = "npm run build"

[functions]
  directory = "netlify/functions"

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
```

### Environment Variables in Netlify
Set these in your Netlify dashboard:
- `SANITY_WRITE_TOKEN`
- `DEEPL_API_KEY` 
- `NETLIFY_BUILD_HOOK` (optional, for auto-rebuild)

## Next Steps

1. **Complete Migration**: Run the migration script to transfer existing data
2. **Set Up Webhooks**: Configure Sanity webhooks to trigger builds
3. **Test Workflow**: Create a test installation and verify translation
4. **Train Editors**: Show team how to use the new CMS interface
5. **Go Live**: Switch DNS to point to new system

## Support

- **Sanity Docs**: https://www.sanity.io/docs
- **Astro Docs**: https://docs.astro.build
- **DeepL API**: https://www.deepl.com/docs-api

## Files Overview

```
├── studio-rosehill-tpv/          # Sanity CMS
│   ├── schemaTypes/
│   │   └── installation.ts       # Content schema
│   └── sanity.config.ts          # CMS configuration
├── site-astro/                   # Static site
│   ├── src/
│   │   ├── pages/               # Route definitions  
│   │   ├── layouts/             # Page templates
│   │   └── lib/sanity.ts        # CMS client
├── netlify/functions/            # Serverless functions
│   └── translate-installation.js # Translation webhook
└── migrate-supabase-to-sanity.js # Migration script
```

This new architecture eliminates all the pain points you experienced with the previous system and provides a scalable, maintainable solution for multilingual content.